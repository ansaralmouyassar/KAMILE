<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Admin ANSAR KAMILE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Orbitron:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
<!-- AJOUTEZ CETTE LIGNE -->
<script>
    // ==================== SESSION ADMIN ====================
    const ADMIN_SESSION_KEY = 'ansar_admin_session';
    const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 heures
    
    // Sauvegarder la session
    function saveAdminSession() {
        const sessionData = {
            loggedIn: true,
            timestamp: new Date().getTime(),
            expiresAt: new Date().getTime() + SESSION_DURATION
        };
        localStorage.setItem(ADMIN_SESSION_KEY, JSON.stringify(sessionData));
    }
    
    // Vérifier la session
    function checkAdminSession() {
        try {
            const sessionData = localStorage.getItem(ADMIN_SESSION_KEY);
            if (!sessionData) return false;
            
            const session = JSON.parse(sessionData);
            const now = new Date().getTime();
            
            if (now > session.expiresAt) {
                localStorage.removeItem(ADMIN_SESSION_KEY);
                return false;
            }
            return true;
        } catch (error) {
            localStorage.removeItem(ADMIN_SESSION_KEY);
            return false;
        }
    }
    
    // Connexion automatique
    async function autoLoginAdmin() {
        if (checkAdminSession()) {
            const loginScreen = document.getElementById('login-screen');
            if (loginScreen) {
                loginScreen.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--accent-color);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <div style="font-size: 1.2rem;">Connexion automatique...</div>
                    </div>
                `;
            }
             
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            currentAdmin = { name: "Administrateur ANSAR" };
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-interface').style.display = 'block';
            loadDashboardData();
            
            return true;
        }
        return false;
    }
</script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    
    <style>
        /* MÊME DESIGN QUE LE SITE DES MEMBRES */
        :root {
            --primary-color: #073332;
            --secondary-color: #1f4a49;
            --accent-color: #9b9c28;
            --bg-color: #073332;
            --text-color: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.7);
            --primary-light: #0a4a48;
            --accent-light: #b5b632;
            --glass-intensity: 0.15;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Open Sans', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            margin: 0;
            padding: 0;
        }
        
        /* FOND DYNAMIQUE IDENTIQUE */
        .dynamic-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: 
                radial-gradient(circle at 30% 40%, var(--primary-light) 0%, transparent 25%),
                radial-gradient(circle at 70% 60%, var(--secondary-color) 0%, transparent 25%);
            opacity: 0.4;
            z-index: -1;
            animation: bgMovement 30s infinite alternate ease-in-out;
        }
        
        @keyframes bgMovement {
            0% { 
                transform: scale(1) rotate(0deg);
                background-position: 0% 0%;
            }
            50% {
                transform: scale(1.1) rotate(5deg);
                background-position: 50% 50%;
            }
            100% {
                transform: scale(1) rotate(0deg);
                background-position: 100% 100%;
            }
        }
        
        .spotlight {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(155, 156, 40, 0.1), transparent 70%);
            filter: blur(20px);
            z-index: 2;
            pointer-events: none;
        }
        
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            background-color: var(--accent-color);
            border-radius: 50%;
            opacity: 0;
            filter: blur(1px);
            animation: float 15s infinite linear;
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 0.3;
            }
            90% {
                opacity: 0.3;
            }
            100% {
                transform: translateY(-100px) translateX(100px);
                opacity: 0;
            }
        }
        
        /* HEADER ADMIN */
        .admin-header {
            background: rgba(7, 51, 50, 0.9);
            backdrop-filter: blur(12px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent-color);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        .admin-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-light));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .refresh-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, var(--primary-light), var(--secondary-color));
        }
        
        .refresh-btn.refreshing {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* CONTAINER PRINCIPAL */
        .admin-container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }
        
        /* DASHBOARD */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .dashboard-card {
            background: rgba(7, 51, 50, 0.7);
            backdrop-filter: blur(12px);
            border-radius: 15px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 1px solid rgba(155, 156, 40, 0.2);
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.05);
        }
        
        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(155, 156, 40, 0.1),
                transparent
            );
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: var(--accent-color);
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.4),
                0 0 0 2px rgba(155, 156, 40, 0.3);
        }
        
        .dashboard-card:hover::before {
            transform: translateX(100%);
        }
        
        .card-icon {
            font-size: 3.5rem;
            color: var(--accent-color);
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(155, 156, 40, 0.5);
        }
        
        .card-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: white;
            position: relative;
            padding-bottom: 10px;
        }
        
        .card-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 2px;
            background: var(--accent-color);
        }
        
        .card-description {
            color: var(--text-muted);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .notification-badge {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            position: absolute;
            top: 15px;
            right: 15px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }
        
        /* PAGES */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(155, 156, 40, 0.3);
        }
        
        .back-btn {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-light));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .back-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            gap: 15px;
        }
        
        /* LISTE DES MEMBRES */
        .members-list {
            display: grid;
            gap: 15px;
        }
        
        .member-item {
            background: rgba(31, 74, 73, 0.4);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(155, 156, 40, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .member-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--accent-color);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .member-item:hover {
            background: rgba(31, 74, 73, 0.7);
            transform: translateX(10px);
            border-color: var(--accent-color);
        }
        
        .member-item:hover::before {
            transform: scaleY(1);
        }
        
        .member-info {
            flex: 1;
        }
        
        .member-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: white;
            margin-bottom: 5px;
        }
        
        .member-code {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .member-hizb {
            font-size: 0.9rem;
            color: var(--accent-color);
            margin-top: 5px;
        }
        
        .search-bar {
            margin: 20px 0;
            padding: 15px;
            background: rgba(31, 74, 73, 0.3);
            border: 1px solid rgba(155, 156, 40, 0.3);
            border-radius: 8px;
            color: white;
            width: 100%;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .search-bar:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(155, 156, 40, 0.2);
            background: rgba(31, 74, 73, 0.5);
        }
        
        /* GRILLE DES HIZB */
        .hizb-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 25px;
        }
        
        .hizb-item {
            padding: 20px 10px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(31, 74, 73, 0.3);
            border: 2px solid transparent;
            font-family: 'Orbitron', sans-serif;
            position: relative;
            overflow: hidden;
        }
        
        .hizb-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .hizb-item.selected {
            background: var(--accent-color);
            color: white;
            font-weight: bold;
            border-color: var(--accent-light);
            animation: pulse 2s infinite;
        }
        
        .hizb-item.assigned {
            background: #28a745;
            color: white;
            border-color: #1e7e34;
        }
        
        .hizb-item.taken {
            background: #dc3545;
            color: white;
            cursor: not-allowed;
            border-color: #c82333;
            opacity: 0.7;
        }
        
        .hizb-item.available {
            background: rgba(31, 74, 73, 0.5);
            color: white;
        }
        
        .hizb-number {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .hizb-status {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(155, 156, 40, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(155, 156, 40, 0); }
        }
        
        /* SEMAINE ACTUELLE */
        .current-week {
            background: rgba(155, 156, 40, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid var(--accent-color);
        }
        
        .week-title {
            color: var(--accent-color);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* BOUTONS */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-light));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            flex: 1;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .btn-secondary {
            background: rgba(108, 117, 125, 0.5);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .btn-secondary:hover {
            background: rgba(108, 117, 125, 0.8);
            transform: translateY(-3px);
        }
        
        /* CHAT */
       /* CHAT PLEIN ÉCRAN */


 

/* Message reçu (membre) - À GAUCHE */
.message-member {
    background: linear-gradient(135deg, rgba(31, 74, 73, 0.9), rgba(7, 51, 50, 0.9));
    align-self: flex-start;
    max-width: 70%;
    border-left: 4px solid var(--accent-color);
    margin-right: auto;
}

/* Message envoyé (admin) - À DROITE */
.message-admin {
    background: linear-gradient(135deg, rgba(155, 156, 40, 0.3), rgba(7, 51, 50, 0.9));
    align-self: flex-end;
    max-width: 70%;
    border-right: 4px solid var(--secondary-color);
    margin-left: auto;
}

.message-item {
    padding: 15px 20px;
    border-radius: 15px;
    position: relative;
    word-wrap: break-word;
    word-break: break-word;
    white-space: pre-wrap; /* Affiche le texte complet avec saut de ligne */
    line-height: 1.5;
}

/* Supprimez ces contraintes de largeur si elles existent */
.message-member, .message-admin {
    min-width: auto; /* Supprime les contraintes de largeur */
}

.message-sender {
    font-size: 0.85rem;
    color: var(--accent-color);
    margin-bottom: 8px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.message-text {
    font-size: 1rem;
    line-height: 1.5;
}

.message-time {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 8px;
    text-align: right;
}

  
.message-input input {
    flex: 1;
    padding: 18px 20px;
    background: rgba(31, 74, 73, 0.6);
    border: 2px solid rgba(155, 156, 40, 0.4);
    border-radius: 10px;
    color: white;
    font-size: 1.05rem;
    transition: all 0.3s ease;
}

.message-input input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(155, 156, 40, 0.2);
    background: rgba(31, 74, 73, 0.8);
}

/* Améliorez les éléments de membre dans la sidebar */
.member-item .member-info {
    flex: 1;
    min-width: 0; /* Permet au texte de bien tronquer */
    overflow: hidden;
}

.member-item .member-name {
    font-size: 1rem;
    margin-bottom: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.member-item .last-message {
    font-size: 0.85rem;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
}
        
        /* PROGRESSION */
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        
        .progress-item {
            padding: 20px 10px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-family: 'Orbitron', sans-serif;
            position: relative;
            overflow: hidden;
        }
        
        .progress-item.read {
            background: #28a745;
            color: white;
            border-color: #1e7e34;
        }
        
        .progress-item.unread {
            background: #dc3545;
            color: white;
            border-color: #c82333;
        }
        
        .progress-item.unassigned {
            background: rgba(108, 117, 125, 0.5);
            color: var(--text-muted);
            cursor: default;
        }
        
        .progress-item:hover:not(.unassigned) {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background: var(--primary-color);
            padding: 35px;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid var(--accent-color);
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.5),
                0 0 0 1px rgba(255,255,255,0.1);
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--accent-color);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            transform: rotate(90deg) scale(1.1);
            background: var(--accent-light);
        }
        
      /* Placeholder du chat */
.chat-placeholder {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--text-muted);
    background: rgba(7, 51, 50, 0.4);
    border-radius: 12px;
    border: 2px dashed rgba(155, 156, 40, 0.3);
}

.placeholder-content {
    text-align: center;
    max-width: 400px;
    padding: 40px;
}

.placeholder-content i {
    font-size: 5rem;
    margin-bottom: 25px;
    opacity: 0.2;
    color: var(--accent-color);
}

.placeholder-text {
    font-size: 1.3rem;
    margin-bottom: 15px;
    color: white;
    opacity: 0.7;
}

.placeholder-hint {
    font-size: 0.9rem;
    color: var(--text-muted);
}

/* Pour s'assurer que le chat prend bien tout l'espace */
#messages-page {
    height: calc(100vh - 120px);
}

#messages-page .page-header {
    margin-bottom: 15px;
    padding-bottom: 10px;
}
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .hizb-grid, .progress-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
            
            .chat-container {
                flex-direction: column;
                height: auto;
            }
            
            .chat-sidebar {
                width: 100%;
                max-height: 200px;
            }
            
            .admin-header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
        
        /* STATISTIQUES */
      /* STATISTIQUES COMPACTES */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
    margin: 15px 0 25px 0;
}

.stat-card {
    background: rgba(31, 74, 73, 0.4);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    border: 1px solid rgba(155, 156, 40, 0.2);
    transition: all 0.3s ease;
    min-height: 90px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.stat-card:hover {
    transform: translateY(-2px);
    border-color: var(--accent-color);
    background: rgba(31, 74, 73, 0.6);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.stat-card i {
    font-size: 1.5rem;
    color: var(--accent-color);
    margin-bottom: 8px;
}

.stat-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--accent-color);
    margin: 5px 0;
    line-height: 1.2;
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.8rem;
    line-height: 1.2;
}
      
      /* Amélioration de l'affichage des membres dans le chat */
.member-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start; /* Modifié de center à flex-start */
    padding: 15px;
    background: rgba(31, 74, 73, 0.3);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid rgba(155, 156, 40, 0.1);
    margin-bottom: 10px;
}

.member-item:hover {
    background: rgba(31, 74, 73, 0.6);
    transform: translateX(5px);
    border-color: var(--accent-color);
}

.member-info {
    flex: 1;
    min-width: 0; /* Permet le text-overflow */
}

.member-name {
    font-weight: bold;
    font-size: 1rem;
    color: white;
    margin-bottom: 5px;
}

/* Style pour les membres sans messages */
.no-messages {
    opacity: 0.7;
}

/* Badge de notification amélioré */
.notification-badge {
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: bold;
    box-shadow: 0 0 8px rgba(220, 53, 69, 0.5);
}
      /* Membre sélectionné dans le chat */
.member-item.selected {
    background: rgba(155, 156, 40, 0.3);
    border-color: var(--accent-color);
    border-left: 4px solid var(--accent-color);
}
      @media (max-width: 768px) {
    .chat-container {
        flex-direction: column;
        height: calc(100vh - 180px);
        padding: 10px;
        gap: 10px;
    }
    
    .chat-sidebar {
        width: 100%;
        max-height: 200px;
        order: 2;
    }
    
    .chat-main, .chat-placeholder {
        order: 1;
        min-height: 300px;
    }
    
    .message-member, .message-admin {
        max-width: 85%;
    }
    
    .message-input {
        flex-direction: column;
    }
    
    .message-input input {
        width: 100%;
    }
    
    #messages-page {
        height: auto;
        min-height: calc(100vh - 120px);
    }
}
      /* LISTE DES MEMBRES EN PLEIN ÉCRAN */
.members-list-full {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 10px;
}

.member-chat-card {
    background: rgba(31, 74, 73, 0.5);
    padding: 20px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid rgba(155, 156, 40, 0.2);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.member-chat-card:hover {
    background: rgba(31, 74, 73, 0.8);
    transform: translateY(-5px);
    border-color: var(--accent-color);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

.member-chat-card.selected {
    background: rgba(155, 156, 40, 0.2);
    border-color: var(--accent-color);
    border-left: 5px solid var(--accent-color);
}

.member-chat-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.member-chat-name {
    font-weight: bold;
    font-size: 1.2rem;
    color: white;
}

.member-chat-code {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-top: 2px;
}

.member-chat-lastmsg {
    font-size: 0.95rem;
    color: var(--text-muted);
    line-height: 1.4;
    max-height: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.member-chat-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.member-chat-time {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.member-chat-badge {
    background: #dc3545;
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
}

.member-chat-badge.read {
    background: #28a745;
}

/* MODAL DE CHAT AMÉLIORÉ */
#chat-modal .modal-content {
    animation: modalAppear 0.3s ease-out;
}

@keyframes modalAppear {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

/* MESSAGES DANS LE MODAL */
.message-modal-item {
    padding: 10px 14px !important; /* Réduit de 18px 22px */
    border-radius: 14px !important; /* Réduit de 18px */
    max-width: 70% !important;
    font-size: 0.95rem !important; /* Réduit de 1.05rem */
    line-height: 1.4 !important;
    margin: 4px 0 !important; /* Réduit de 20px */
}

.message-modal-member {
    background: linear-gradient(135deg, rgba(31, 74, 73, 0.9), rgba(7, 51, 50, 0.9));
    align-self: flex-start;
    margin-right: auto;
    border-left: 4px solid var(--accent-color);
}

.message-modal-admin {
    background: linear-gradient(135deg, rgba(155, 156, 40, 0.3), rgba(31, 74, 73, 0.9));
    align-self: flex-end;
    margin-left: auto;
    border-right: 4px solid var(--secondary-color);
}

.message-modal-sender {
    font-size: 0.9rem;
    color: var(--accent-color);
    margin-bottom: 8px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
}

.message-modal-time {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-align: right;
    margin-top: 6px;
    opacity: 0.8;
}
#modal-messages-container {
    padding: 15px !important; /* Réduit de 25px */
    gap: 12px !important; /* Réduit de 20px */
}
.message-input-modal input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(155, 156, 40, 0.2);
}

/* Aucun message */
.no-messages {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
}

.no-messages i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.3;
}
      @media (max-width: 768px) {
    .members-list-full {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .member-chat-card {
        padding: 15px;
    }
    
    #chat-modal .modal-content {
        width: 98%;
        height: 90vh;
        margin: 10px;
    }
    
    .message-modal-item {
        max-width: 85%;
        padding: 15px;
    }
    
    .message-input-modal {
        flex-direction: column;
    }
    
    .message-input-modal input {
        width: 100%;
    }
    
    #modal-send-btn {
        width: 100%;
        margin-top: 10px;
    }
}
      
      /* Date séparateur comme WhatsApp */
.date-separator {
    text-align: center;
    margin: 25px 0;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

.date-separator::before,
.date-separator::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgba(155, 156, 40, 0.3);
    margin: 0 15px;
}

.date-separator span {
    background: rgba(31, 74, 73, 0.5);
    color: var(--text-muted);
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 0.85rem;
    display: inline-block;
}
      /* Style pour les boutons dans la progression */
.progress-grid .hizb-buttons {
    display: flex;
    gap: 5px;
    justify-content: center;
    margin-top: 10px;
}

.hizb-button-small {
    padding: 6px 12px !important;
    font-size: 0.7rem !important;
    border-radius: 6px !important;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
}

.hizb-button-small:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
}

.hizb-button-small:active {
    transform: translateY(0);
}

.btn-mark-read {
    background: #28a745 !important;
    color: white !important;
}

.btn-mark-unread {
    background: #dc3545 !important;
    color: white !important;
}

.btn-chat {
    background: var(--secondary-color) !important;
    color: white !important;
}
      /* STYLES POUR LES CATÉGORIES DE MESSAGES */
.member-chat-card.unreplied {
    border-left: 5px solid #dc3545;
    background: rgba(220, 53, 69, 0.1);
    animation: pulseBorder 2s infinite;
}

@keyframes pulseBorder {
    0%, 100% { border-left-color: #dc3545; }
    50% { border-left-color: rgba(220, 53, 69, 0.5); }
}

.member-chat-card.has-unread {
    border: 2px solid var(--accent-color);
    background: rgba(155, 156, 40, 0.1);
}

.member-chat-status {
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Style pour les sections */
.section-title {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 20px;
    background: rgba(31, 74, 73, 0.5);
    border-radius: 10px;
    margin-bottom: 15px;
    border-left: 5px solid;
}

.section-title.pending {
    border-left-color: #dc3545;
    color: #dc3545;
}

.section-title.unread {
    border-left-color: var(--accent-color);
    color: var(--accent-color);
}

.section-title.all {
    border-left-color: var(--secondary-color);
    color: var(--text-color);
}

/* Badges améliorés */
.member-chat-badge {
    background: #dc3545;
    color: white;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
    animation: pulseBadge 1.5s infinite;
}

@keyframes pulseBadge {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.member-chat-badge.replied {
    background: #28a745;
}
      /* BADGES POUR LES DIFFÉRENTS TYPES */
.pending-badge {
    background: #dc3545;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    animation: pulse 1.5s infinite;
}

.unread-badge {
    background: var(--accent-color);
    color: white;
    min-width: 24px;
    height: 24px;
    padding: 0 8px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
}

/* STYLES SPÉCIFIQUES POUR LES CARTES */
.member-chat-card.pending {
    border: 2px solid rgba(220, 53, 69, 0.3);
    background: rgba(220, 53, 69, 0.05);
    position: relative;
}

.member-chat-card.pending::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: #dc3545;
    border-radius: 4px 0 0 4px;
}

.member-chat-card.unread {
    border: 2px solid rgba(155, 156, 40, 0.3);
    background: rgba(155, 156, 40, 0.05);
}

.member-chat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

/* ANIMATION DE PULSATION */
@keyframes pulse {
    0%, 100% { 
        transform: scale(1); 
        opacity: 1; 
    }
    50% { 
        transform: scale(1.1); 
        opacity: 0.8; 
    }
}
      /* ========== PAGE DE CONNEXION PREMIUM ========== */

#login-screen {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
    background: linear-gradient(135deg, #071a19 0%, #0a2a29 50%, #073332 100%);
    position: relative;
    overflow: hidden;
}

/* Fond animé */
#login-screen::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 30%, rgba(155, 156, 40, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(31, 74, 73, 0.2) 0%, transparent 40%);
    animation: bgPulse 8s infinite alternate;
}

@keyframes bgPulse {
    0% { opacity: 0.3; }
    100% { opacity: 0.7; }
}

/* Container principal */
.login-container {
    width: 100%;
    max-width: 420px;
    position: relative;
    z-index: 10;
}

/* Header */
.login-header {
    text-align: center;
    margin-bottom: 40px;
    animation: fadeInDown 0.8s ease;
}

.login-logo {
    width: 80px;
    height: 80px;
    margin: 0 auto 25px;
    background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 
        0 10px 30px rgba(155, 156, 40, 0.4),
        0 0 0 4px rgba(155, 156, 40, 0.2),
        inset 0 0 20px rgba(255, 255, 255, 0.1);
    animation: logoFloat 6s ease-in-out infinite;
}

.login-logo i {
    font-size: 2.5rem;
    color: white;
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
}

@keyframes logoFloat {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-10px) scale(1.05); }
}

.login-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 10px;
    background: linear-gradient(135deg, var(--accent-color), #ffffff, var(--secondary-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: 1px;
}

.login-subtitle {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1rem;
    letter-spacing: 3px;
    text-transform: uppercase;
}

/* Carte de connexion */
.login-card {
    background: rgba(7, 51, 50, 0.85);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    border: 1px solid rgba(155, 156, 40, 0.3);
    box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.05),
        inset 0 0 30px rgba(31, 74, 73, 0.4);
    overflow: hidden;
    animation: cardAppear 0.6s ease-out;
}

@keyframes cardAppear {
    from { 
        opacity: 0; 
        transform: translateY(30px) scale(0.95); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
    }
}

.card-header {
    padding: 30px 30px 20px;
    text-align: center;
    background: linear-gradient(135deg, rgba(31, 74, 73, 0.8), rgba(7, 51, 50, 0.9));
    border-bottom: 1px solid rgba(155, 156, 40, 0.2);
}

.card-header h2 {
    color: white;
    font-family: 'Orbitron', sans-serif;
    font-size: 1.4rem;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.card-header h2 i {
    color: var(--accent-color);
    font-size: 1.2rem;
}

.card-header p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
}

.card-body {
    padding: 30px;
}

/* Input group premium */
.input-group {
    position: relative;
    margin-bottom: 30px;
}

.input-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--accent-color);
    font-size: 1.1rem;
    z-index: 2;
}

.input-group input {
    width: 100%;
    padding: 18px 18px 18px 50px;
    background: rgba(31, 74, 73, 0.4);
    border: 2px solid rgba(155, 156, 40, 0.2);
    border-radius: 12px;
    color: white;
    font-size: 1.1rem;
    font-family: 'Open Sans', sans-serif;
    transition: all 0.3s ease;
    outline: none;
}

.input-group input:focus {
    background: rgba(31, 74, 73, 0.6);
    border-color: var(--accent-color);
    box-shadow: 
        0 0 0 3px rgba(155, 156, 40, 0.2),
        inset 0 0 20px rgba(31, 74, 73, 0.8);
}

.input-label {
    position: absolute;
    left: 50px;
    top: 18px;
    color: rgba(255, 255, 255, 0.6);
    font-size: 1rem;
    pointer-events: none;
    transition: all 0.3s ease;
    transform-origin: left;
}

.input-group input:focus + .input-label,
.input-group input:not(:placeholder-shown) + .input-label {
    transform: translateY(-28px) scale(0.85);
    color: var(--accent-color);
    left: 15px;
    font-weight: 600;
}

.input-line {
    position: absolute;
    bottom: 0;
    left: 15px;
    right: 15px;
    height: 2px;
    background: linear-gradient(90deg, var(--accent-color), transparent);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.input-group input:focus ~ .input-line {
    transform: scaleX(1);
}

/* Bouton de connexion */
.login-btn {
    width: 100%;
    padding: 18px;
    background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
    border: none;
    border-radius: 12px;
    color: white;
    font-family: 'Orbitron', sans-serif;
    font-size: 1rem;
    font-weight: 600;
    letter-spacing: 1px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    margin-top: 10px;
    box-shadow: 0 8px 25px rgba(155, 156, 40, 0.3);
}

.login-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.2),
        transparent
    );
    transition: all 0.6s ease;
}

.login-btn:hover {
    transform: translateY(-3px);
    box-shadow: 
        0 12px 35px rgba(155, 156, 40, 0.5),
        0 0 0 2px rgba(155, 156, 40, 0.3);
}

.login-btn:hover::before {
    left: 100%;
}

.login-btn:active {
    transform: translateY(0);
}

.login-btn .btn-text {
    position: relative;
    z-index: 1;
}

.login-btn i {
    font-size: 1.1rem;
    transition: transform 0.3s ease;
}

.login-btn:hover i {
    transform: translateX(5px);
}

/* Message d'erreur */
.error-message {
    color: #ff6b6b;
    font-size: 0.9rem;
    text-align: center;
    margin: 15px 0;
    min-height: 20px;
    padding: 8px;
    background: rgba(220, 53, 69, 0.1);
    border-radius: 8px;
    border-left: 3px solid #dc3545;
    display: none;
    animation: shake 0.5s ease;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* Footer */
.login-footer {
    margin-top: 30px;
    text-align: center;
}

.security-info {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.85rem;
    margin-bottom: 15px;
    padding: 12px;
    background: rgba(31, 74, 73, 0.3);
    border-radius: 10px;
    border: 1px solid rgba(155, 156, 40, 0.1);
}

.security-info i {
    color: var(--accent-color);
    font-size: 1rem;
}

.version {
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.8rem;
    letter-spacing: 1px;
}

/* Cercles décoratifs */
.decoration-circle {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(155, 156, 40, 0.1), transparent 70%);
    filter: blur(20px);
    z-index: 1;
    animation: float 20s infinite linear;
}

.circle-1 {
    width: 300px;
    height: 300px;
    top: -150px;
    right: -150px;
    animation-delay: 0s;
}

.circle-2 {
    width: 200px;
    height: 200px;
    bottom: -100px;
    left: -100px;
    background: radial-gradient(circle, rgba(31, 74, 73, 0.15), transparent 70%);
    animation-delay: -5s;
    animation-direction: reverse;
}

.circle-3 {
    width: 150px;
    height: 150px;
    top: 50%;
    left: 10%;
    background: radial-gradient(circle, rgba(155, 156, 40, 0.08), transparent 70%);
    animation-delay: -10s;
}

@keyframes float {
    0% { transform: rotate(0deg) translateX(20px) rotate(0deg); }
    100% { transform: rotate(360deg) translateX(20px) rotate(-360deg); }
}

/* Responsive */
@media (max-width: 480px) {
    .login-container {
        max-width: 350px;
    }
    
    .login-logo {
        width: 70px;
        height: 70px;
    }
    
    .login-logo i {
        font-size: 2rem;
    }
    
    .login-title {
        font-size: 1.5rem;
    }
    
    .card-header,
    .card-body {
        padding: 25px 20px;
    }
    
    .input-group input {
        padding: 16px 16px 16px 45px;
        font-size: 1rem;
    }
    
    .login-btn {
        padding: 16px;
        font-size: 0.95rem;
    }
}
      /* Styles pour la poubelle et la confirmation */
.btn-trash {
    background: #dc3545 !important;
    color: white !important;
    padding: 6px 12px !important;
    border-radius: 6px !important;
    border: none !important;
    cursor: pointer !important;
    font-size: 0.8rem !important;
    transition: all 0.2s ease !important;
    display: flex !important;
    align-items: center !important;
    gap: 5px !important;
    white-space: nowrap !important;
}

.btn-trash:hover {
    background: #c82333 !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 3px 10px rgba(220, 35, 51, 0.3) !important;
}

.confirmation-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    z-index: 4000;
    justify-content: center;
    align-items: center;
}

.confirmation-box {
    background: var(--primary-color);
    padding: 30px;
    border-radius: 15px;
    max-width: 450px;
    width: 90%;
    border: 2px solid #dc3545;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    text-align: center;
}

.confirmation-icon {
    font-size: 3.5rem;
    color: #dc3545;
    margin-bottom: 20px;
}

.confirmation-buttons {
    display: flex;
    gap: 15px;
    margin-top: 25px;
    justify-content: center;
}

.confirm-btn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    flex: 1;
    transition: all 0.3s ease;
}

.confirm-btn:hover {
    background: #c82333;
    transform: translateY(-2px);
}

.cancel-btn {
    background: var(--secondary-color);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    flex: 1;
    transition: all 0.3s ease;
}

.cancel-btn:hover {
    background: var(--primary-light);
    transform: translateY(-2px);
}
      
      /* Style pour le bouton de réinitialisation */
.btn-reset {
    background: linear-gradient(135deg, #dc3545, #c82333) !important;
    color: white !important;
    border: none !important;
    padding: 12px 25px !important;
    border-radius: 8px !important;
    cursor: pointer !important;
    font-family: 'Orbitron', sans-serif !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3) !important;
}

.btn-reset:hover {
    background: linear-gradient(135deg, #c82333, #dc3545) !important;
    transform: translateY(-3px) !important;
    box-shadow: 0 6px 25px rgba(220, 53, 69, 0.4) !important;
}

.btn-reset:active {
    transform: translateY(0) !important;
}
    </style>
</head>
<body>
    <!-- FOND DYNAMIQUE IDENTIQUE -->
    <div class="dynamic-bg"></div>
    <div class="spotlight"></div>
    <div class="particles" id="particles-js"></div>
    
    <!-- ÉCRAN DE CONNEXION -->
   <!-- REMPLACEZ TOUTE LA PAGE DE CONNEXION ACTUELLE PAR CE CODE -->

<div id="login-screen">
    <div class="login-container">
        <!-- Logo et titre premium -->
        <div class="login-header">
            <div class="login-logo">
                <i class="fas fa-user-shield"></i>
            </div>
            <h1 class="login-title">
                <span class="gradient-text">Espace Gérant</span>
            </h1>
            <p class="login-subtitle">ANSAR ALMOUYASSAR</p>
        </div>
        
        <!-- Carte de connexion -->
        <div class="login-card">
            <div class="card-header">
                <h2><i class="fas fa-lock"></i> KAMILE</h2>
                <p>Ne pas partager cette page au public</p>
            </div>
            
            <div class="card-body">
                <form id="admin-login-form">
                    <div class="input-group">
                        <div class="input-icon">
                            <i class="fas fa-key"></i>
                        </div>
                        <input 
                            type="password" 
                            id="admin-code" 
                            placeholder=" "
                            autocomplete="off"
                            autofocus
                        >
                        <label for="admin-code"> </label>
                        <div class="input-line"></div>
                    </div>
                    
                    <div id="admin-error" class="error-message"></div>
                    
                    <button type="submit" class="login-btn">
                        <span class="btn-text">ACCÉDER AU PANEL ADMIN</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </form>
                
                <div class="login-footer">
                    <div class="security-info">
                        <i class="fas fa-shield-alt"></i>
                        <span>Accès réservé aux personnes autorisés</span>
                    </div>
                    <div class="version">Version 8.2.7 • © 2026</div>
                </div>
            </div>
        </div>
        
        <!-- Éléments décoratifs -->
        <div class="decoration-circle circle-1"></div>
        <div class="decoration-circle circle-2"></div>
        <div class="decoration-circle circle-3"></div>
    </div>
</div>
    
    <!-- INTERFACE ADMINISTRATEUR -->
    <div id="admin-interface" style="display: none;">
        <!-- Header -->
        <div class="admin-header">
            <div class="admin-title">
                <i class="fas fa-quran"></i>
                ANSAR KAMILE
                <button class="refresh-btn" onclick="refreshAllData()" id="refresh-btn">
                <i class="fas fa-sync-alt"></i>  
            </button>
            </div>
          
        </div>
        
        <!-- Contenu principal -->
        <div class="admin-container">
            <!-- Dashboard -->
            <div id="dashboard-page">
               
                
                <!-- Statistiques -->
               
                
                <!-- Cartes principales -->
                <div class="dashboard-grid">
                    <div class="dashboard-card" onclick="showProgressPage()">
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="card-title">KAMILE ACTUEL</div>
                        <div class="card-description">Suivre la lecture des 60 hizb</div>
                        <div id="progress-stats" style="margin-top: 15px; color: var(--accent-color); font-size: 0.9rem;"></div>
                    </div>
                      <div class="dashboard-card" onclick="showMessagesPage()">
                        <div class="card-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="card-title">Messages</div>
                        <div class="card-description">Voir et répondre aux messages des membres</div>
                        <span id="message-notif" class="notification-badge" style="display: none;">0</span>
                    </div>
                    <div class="dashboard-card" onclick="showMembersPage()">
                        <div class="card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="card-title">Liste des Membres</div>
                        <div class="card-description">Gérer tous les membres et assigner les hizb</div>
                        <div id="members-count" style="margin-top: 15px; color: var(--accent-color); font-size: 0.9rem;"></div>
                    </div>
                    
                 <h2 style="margin-bottom: 30px; color: var(--accent-color); font-family: 'Orbitron', sans-serif;">
                    <i class="fas fa-tachometer-alt"></i> Statistiques
                </h2>
                     <div class="stats-grid" id="stats-container">
                    <!-- Statistiques dynamiques -->
                </div>
                  
                </div>
            </div>
            
            <!-- Page Liste des Membres -->
            <div id="members-page" style="display: none;">
                <div class="page-header">
                    <button class="back-btn" onclick="showDashboard()">
                        <i class="fas fa-arrow-left"></i> 
                    </button>
                    <h2 style="color: var(--accent-color); font-family: 'Orbitron', sans-serif;">
                        <i class="fas fa-users"></i> Liste des Membres
                    </h2>
                </div>
                
                <div class="current-week">
                    <div class="week-title">
                        <i class="fas fa-calendar-week"></i> 
                        <span id="current-week-display"></span>
                    </div>
                    <div style="color: var(--text-muted);">
                        Assignez les hizb pour cette semaine. Les hizb déjà attribués sont en rouge et non sélectionnables.
                    </div>
                </div>
                
                <input type="text" class="search-bar" id="member-search" placeholder="Rechercher un membre par nom ou code...">
                
                <div class="members-list" id="members-list-container">
                    <!-- Liste dynamique -->
                </div>
            </div>
            
            <!-- Page Assignation Hizb -->
            <div id="assign-hizb-page" style="display: none;">
                <div class="page-header">
                    <button class="back-btn" onclick="showMembersPage()">
                        <i class="fas fa-arrow-left"></i>  
                    </button>
                    <h2 id="assign-member-name" style="color: var(--accent-color); font-family: 'Orbitron', sans-serif;"></h2>
                </div>
                
                <div class="current-week">
                    <div class="week-title">
                        <i class="fas fa-calendar-week"></i> 
                        <span id="assign-week-display"></span>
                    </div>
                    <div style="color: var(--text-muted);">
                        Sélectionnez les hizb à assigner. <span style="color: #28a745;">Vert</span> = Disponible, 
                        <span style="color: #dc3545;">Rouge</span> = Déjà attribué à un autre membre
                    </div>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: rgba(155, 156, 40, 0.1); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-info-circle" style="color: var(--accent-color);"></i>
                        <div style="font-weight: bold;">Hizb sélectionnés :</div>
                    </div>
                    <div id="selected-hizb-display" style="display: flex; flex-wrap: wrap; gap: 10px; min-height: 40px;">
                        Aucun hizb sélectionné
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px; color: white;">Sélectionnez les hizb :</h3>
                <div class="hizb-grid" id="hizb-selection-grid">
                    <!-- 60 hizb -->
                </div>
                
                <div class="action-buttons">
                    <button id="assign-hizb-btn" class="btn-primary" disabled>
                        <i class="fas fa-check-circle"></i> Assigner les hizb sélectionnés
                    </button>
                    <button onclick="showMembersPage()" class="btn-secondary">
                        <i class="fas fa-times"></i> Annuler
                    </button>
                </div>
            </div>
            
            <!-- Page Messages -->
         
            <!-- Page Messages - VERSION SIMPLIFIÉE -->
<div id="messages-page" style="display: none;">
    <div class="page-header">
        <button class="back-btn" onclick="showDashboard()">
            <i class="fas fa-arrow-left"></i> 
        </button>
        <h2 style="color: var(--accent-color); font-family: 'Orbitron', sans-serif;">
            <i class="fas fa-comments"></i> Messages 
        </h2>
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="refresh-btn" onclick="loadMessages()">
                <i class="fas fa-sync-alt"></i>  
            </button>
            <span id="unread-count-badge" style="background: #dc3545; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; display: none;">
                <i class="fas fa-envelope"></i> <span id="unread-count">0</span> non lu(s)
            </span>
        </div>
    </div>
    
    <!-- Barre de recherche -->
    <input type="text" class="search-bar" id="messages-search" placeholder="Rechercher un membre par nom..." style="margin-bottom: 25px;">
    
    <!-- Liste des membres en plein écran -->
    <div class="members-list-full" id="members-chat-list">
        <!-- Liste dynamique des membres avec messages -->
    </div>
</div>

<!-- MODAL DE CHAT (s'affiche quand on clique sur un membre) -->
<div id="chat-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 900px; width: 95%; height: 85vh; display: flex; flex-direction: column; padding: 0;">
        <!-- En-tête du chat -->
        <div style="padding: 20px 25px; border-bottom: 1px solid rgba(155, 156, 40, 0.3); display: flex; justify-content: space-between; align-items: center; background: rgba(7, 51, 50, 0.9); border-radius: 15px 15px 0 0;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--accent-color), var(--secondary-color)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-user" style="font-size: 1.5rem; color: white;"></i>
                </div>
                <div>
                    <h3 style="color: var(--accent-color); margin: 0; font-family: 'Orbitron', sans-serif;">
                        Chat avec <span id="modal-member-name">[Nom]</span>
                    </h3>
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Code: <span id="modal-member-code">[Code]</span></div>
                </div>
            </div>
            <button class="modal-close" onclick="closeChatModal()" style="position: static; transform: none;">×</button>
        </div>
        
        <!-- Zone des messages -->
        <div id="modal-messages-container" style="flex: 1; overflow-y: auto; padding: 25px; background: rgba(7, 51, 50, 0.6); display: flex; flex-direction: column; gap: 20px;">
            <!-- Messages chargés dynamiquement -->
        </div>
        
        <!-- Zone d'envoi -->
        <div style="padding: 20px 25px; border-top: 1px solid rgba(155, 156, 40, 0.3); background: rgba(7, 51, 50, 0.9); border-radius: 0 0 15px 15px;">
            <div class="message-input-modal" style="display: flex; gap: 15px;">
                <input type="text" id="modal-chat-input" placeholder="Tapez votre message ici..." style="flex: 1; padding: 18px 20px; background: rgba(31, 74, 73, 0.7); border: 2px solid rgba(155, 156, 40, 0.4); border-radius: 10px; color: white; font-size: 1.05rem;">
                <button id="modal-send-btn" class="btn-primary" style="padding: 18px 30px; white-space: nowrap;">
                    <i class="fas fa-paper-plane"></i> Envoyer
                </button>
            </div>
        </div>
    </div>
</div>
            <!-- Page Progression -->
            <div id="progress-page" style="display: none;">
                <div class="page-header">
                    <button class="back-btn" onclick="showDashboard()">
                        <i class="fas fa-arrow-left"></i> 
                    </button>
                    <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
                        <h2 style="color: var(--accent-color); font-family: 'Orbitron', sans-serif;">
                            <i class="fas fa-chart-line"></i> Progression en cours
                        </h2>
                       
                        <button onclick="showHistoryModal()" class="btn-primary">
                            <i class="fas fa-history"></i>  Historiques
                        </button>
                    </div>
                </div>
                
                <div class="current-week">
                    <div class="week-title">
                        <i class="fas fa-calendar-week"></i> 
                        <span id="progress-week-display"></span>
                    </div>
                    <div style="color: var(--text-muted);">
                        <span style="color: #28a745;">Vert</span> = Hizb déjà lu, 
                        <span style="color: #dc3545;">Rouge</span> = Hizb non encore lu,
                        <span style="color: #6c757d;">Gris</span> = Non attribué
                    </div>
                </div>
                
                <!-- Statistiques de progression -->
                <div id="progress-stats-container" style="margin: 20px 0;">
                    <!-- Statistiques dynamiques -->
                </div>
                
                <div class="progress-grid" id="progress-grid">
                    <!-- 60 hizb avec statut -->
                </div>
              <!-- AJOUTEZ CE BOUTON -->
            <button onclick="confirmResetAllProgress()" class="btn-primary" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                <i class="fas fa-redo"></i> Réinitialiser
            </button>
            </div>
        </div>
    </div>
    
    <!-- Modal Historique -->
    <div id="history-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeHistoryModal()">×</button>
            <h3 style="color: var(--accent-color); margin-bottom: 25px; font-family: 'Orbitron', sans-serif;">
                <i class="fas fa-history"></i> Historique des lectures
            </h3>
            
            <div style="margin-bottom: 20px;">
                <input type="date" id="history-date" class="search-bar" style="margin-bottom: 15px;">
                <input type="text" id="history-search" class="search-bar" placeholder="Rechercher par membre ou hizb...">
            </div>
            
            <div id="history-content" style="max-height: 400px; overflow-y: auto;">
                <!-- Contenu historique -->
            </div>
        </div>
    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyA-TpblN0YnekG2tKFRhjOwwEd80qke5pk",
            authDomain: "ansar-69617.firebaseapp.com",
            projectId: "ansar-69617",
            storageBucket: "ansar-69617.appspot.com",
            messagingSenderId: "1075104578958",
            appId: "1:1075104578958:web:b5d55c76def4d1d430b8df",
            measurementId: "G-5XLSPLXH81"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // Fonction pour limiter les messages à 10 par membre
async function limitMessages(memberCode) {
    try {
        // Solution temporaire sans index
        const snapshot = await db.collection('chatMessages')
            .orderBy('timestamp', 'desc')
            .limit(50) // Récupérer plus pour être sûr
            .get();
        
        // Filtrer côté client par membre
        const memberMessages = [];
        snapshot.docs.forEach(doc => {
            const data = doc.data();
            if (data.memberCode === memberCode) {
                memberMessages.push({
                    id: doc.id,
                    timestamp: data.timestamp
                });
            }
        });
        
        // Trier par date (plus récent en premier)
        memberMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        // Supprimer les messages au-delà de 10
        if (memberMessages.length > 10) {
            const messagesToDelete = memberMessages.slice(10);
            const deletePromises = messagesToDelete.map(msg => 
                db.collection('chatMessages').doc(msg.id).delete()
            );
            await Promise.all(deletePromises);
            console.log(`${messagesToDelete.length} anciens messages supprimés pour ${memberCode}`);
        }
    } catch (error) {
        console.error('Erreur limitation messages:', error);
    }
}
        // Variables globales
        let currentAdmin = null;
        let currentWeekKey = '';
        let currentWeekDisplay = '';
        let selectedMember = null;
        let selectedHizb = [];
        let chatMember = null;
        let takenHizb = new Set();
        
        // Code d'accès administrateur
        const ADMIN_CODE = "ANSAR";
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initAdminApp();
            initParticles();
        });
        
        function initParticles() {
            const container = document.getElementById('particles-js');
            if (!container) return;
            
            const particleCount = Math.floor(window.innerWidth / 15);
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                
                const size = Math.random() * 6 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 120 - 20}%`;
                
                const duration = Math.random() * 20 + 10;
                const delay = Math.random() * 5;
                particle.style.animation = `float ${duration}s linear ${delay}s infinite`;
                
                particle.style.opacity = Math.random() * 0.2;
                
                container.appendChild(particle);
            }
            
            // Effet de lumière qui suit la souris
            const spotlight = document.querySelector('.spotlight');
            if (spotlight) {
                document.addEventListener('mousemove', (e) => {
                    spotlight.style.left = `${e.clientX}px`;
                    spotlight.style.top = `${e.clientY}px`;
                });
            }
        }
      // Fonction pour limiter les messages à 10 par membre
async function limitMessages(memberCode) {
    try {
        const snapshot = await db.collection('chatMessages')
            .where('memberCode', '==', memberCode)
            .orderBy('timestamp', 'desc')
            .get();
        
        if (snapshot.size > 10) {
            const messagesToDelete = snapshot.docs.slice(10);
            const deletePromises = messagesToDelete.map(doc => doc.ref.delete());
            await Promise.all(deletePromises);
        }
    } catch (error) {
        console.error('Erreur limitation messages:', error);
    }
}
        // Fonction pour échapper le HTML (sécurité)
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
      async function initAdminApp() {
    // Calculer la semaine actuelle (du lundi au dimanche)
    const today = new Date();
    const dayOfWeek = today.getDay();
    const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() + diffToMonday);
    
    const endOfWeek = new Date(startOfWeek);
    endOfWeek.setDate(startOfWeek.getDate() + 6);
    
    currentWeekKey = `semaine_${startOfWeek.toISOString().split('T')[0]}`;
    currentWeekDisplay = `Semaine du ${formatDate(startOfWeek)} au ${formatDate(endOfWeek)}`;
    
    document.getElementById('current-week-display').textContent = currentWeekDisplay;
    document.getElementById('assign-week-display').textContent = currentWeekDisplay;
    document.getElementById('progress-week-display').textContent = currentWeekDisplay;
    
    // Gestion de la connexion
    document.getElementById('admin-login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const code = document.getElementById('admin-code').value.trim();
        
        if (code === ADMIN_CODE) {
            currentAdmin = { name: "Administrateur ANSAR" };
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-interface').style.display = 'block';
            loadDashboardData();
            
            // 👇 AJOUTER CETTE LIGNE ICI 👇
            initAutoResetTimer(); // Démarre le minuteur après connexion
            
        } else {
            const errorEl = document.getElementById('admin-error');
            errorEl.textContent = "Code administrateur incorrect";
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 3000);
        }
    });
}
        
        // Navigation
        function showDashboard() {
            hideAllPages();
            document.getElementById('dashboard-page').style.display = 'block';
            loadDashboardData();
        }
        
        function showMembersPage() {
            hideAllPages();
            document.getElementById('members-page').style.display = 'block';
            loadMembersList();
        }
        
        function showMessagesPage() {
            hideAllPages();
            document.getElementById('messages-page').style.display = 'block';
            loadMessages();
        }
        
        function showProgressPage() {
            hideAllPages();
            document.getElementById('progress-page').style.display = 'block';
            loadProgress();
        }
        
        function showAssignHizbPage(member) {
            selectedMember = member;
            selectedHizb = [];
            hideAllPages();
            document.getElementById('assign-hizb-page').style.display = 'block';
            document.getElementById('assign-member-name').innerHTML = `
                <i class="fas fa-user"></i> Assigner des Hizb à ${member.firstname} ${member.lastname}
            `;
            loadHizbSelection();
        }
        
        function hideAllPages() {
            const pages = ['dashboard-page', 'members-page', 'messages-page', 'progress-page', 'assign-hizb-page'];
            pages.forEach(page => {
                document.getElementById(page).style.display = 'none';
            });
        }
        
        // Charger les données du dashboard
        async function loadDashboardData() {
            try {
                const [membersSnapshot, messagesSnapshot, assignmentsSnapshot] = await Promise.all([
                    db.collection("members").get(),
                    db.collection('chatMessages').where('read', '==', false).where('sender', '==', 'member').get(),
                    db.collection('hizbAssignments').where('week', '==', currentWeekKey).get()
                ]);
                
                // Mettre à jour les compteurs
                document.getElementById('members-count').textContent = `${membersSnapshot.size} membres`;
                
                const unreadMessages = messagesSnapshot.size;
                const notifBadge = document.getElementById('message-notif');
                if (unreadMessages > 0) {
                    notifBadge.textContent = unreadMessages;
                    notifBadge.style.display = 'flex';
                } else {
                    notifBadge.style.display = 'none';
                }
                
                // Statistiques
                const statsContainer = document.getElementById('stats-container');
                const assignedHizb = assignmentsSnapshot.size;
                const readHizb = await getReadHizbCount();
                
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <i class="fas fa-users" style="font-size: 2rem; color: var(--accent-color);"></i>
                        <div class="stat-value">${membersSnapshot.size}</div>
                        <div class="stat-label">Membres total</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-book-quran" style="font-size: 2rem; color: var(--accent-color);"></i>
                        <div class="stat-value">${assignedHizb}</div>
                        <div class="stat-label">Hizb assignés</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--accent-color);"></i>
                        <div class="stat-value">${readHizb}</div>
                        <div class="stat-label">Hizb lus</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-envelope" style="font-size: 2rem; color: var(--accent-color);"></i>
                        <div class="stat-value">${unreadMessages}</div>
                        <div class="stat-label">Messages non lus</div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
            }
        }
        
        async function getReadHizbCount() {
            try {
                const snapshot = await db.collection('hizbReadStatus')
                    .where('week', '==', currentWeekKey)
                    .get();
                return snapshot.size;
            } catch (error) {
                console.error('Erreur comptage hizb lus:', error);
                return 0;
            }
        }
        
        // Charger la liste des membres avec leurs hizb assignés
        async function loadMembersList() {
            try {
                const [membersSnapshot, assignmentsSnapshot] = await Promise.all([
                    db.collection("members").get(),
                    db.collection('hizbAssignments').where('week', '==', currentWeekKey).get()
                ]);
                
                const members = membersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const assignments = new Map();
                
                assignmentsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (!assignments.has(data.memberCode)) {
                        assignments.set(data.memberCode, []);
                    }
                    assignments.get(data.memberCode).push(data.hizb);
                });
                
                const container = document.getElementById('members-list-container');
                container.innerHTML = members.map(member => {
                    const memberHizb = assignments.get(member.code) || [];
                    const hizbText = memberHizb.length > 0 
                        ? memberHizb.map(h => `Hizb ${h}`).join(', ')
                        : 'Aucun hizb assigné';
                    
                    return `
                        <div class="member-item" onclick="showAssignHizbPage(${JSON.stringify(member).replace(/"/g, '&quot;')})">
                            <div class="member-info">
                                <div class="member-name">${member.firstname} ${member.lastname}</div>
                                <div class="member-code">Code: ${member.code}</div>
                                <div class="member-hizb" style="color: ${memberHizb.length > 0 ? 'var(--accent-color)' : '#dc3545'}">
                                    <i class="fas ${memberHizb.length > 0 ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                    ${hizbText}
                                </div>
                            </div>
                            <i class="fas fa-chevron-right" style="color: var(--accent-color);"></i>
                        </div>
                    `;
                }).join('');
                
                // Recherche
                document.getElementById('member-search').addEventListener('input', function(e) {
                    const search = e.target.value.toLowerCase();
                    const items = document.querySelectorAll('.member-item');
                    items.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        item.style.display = text.includes(search) ? 'flex' : 'none';
                    });
                });
                
            } catch (error) {
                console.error('Erreur chargement membres:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <div>Erreur de chargement des membres</div>
                    </div>
                `;
            }
        }
        
        // Charger la sélection des hizb avec les hizb déjà pris en gras et non sélectionnables
        async function loadHizbSelection() {
            try {
                // Récupérer tous les hizb déjà assignés cette semaine (sauf au membre sélectionné)
                const assignmentsSnapshot = await db.collection('hizbAssignments')
                    .where('week', '==', currentWeekKey)
                    .get();
                
                takenHizb.clear();
                const memberCurrentHizb = new Set();
                
                assignmentsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.memberCode === selectedMember.code) {
                        // Hizb déjà assignés à ce membre
                        memberCurrentHizb.add(data.hizb);
                    } else {
                        // Hizb assignés à d'autres membres
                        takenHizb.add(data.hizb);
                    }
                });
                
                // Récupérer les hizb déjà lus par le membre
                const readSnapshot = await db.collection('hizbReadStatus')
                    .where('memberCode', '==', selectedMember.code)
                    .where('week', '==', currentWeekKey)
                    .get();
                
                const readHizb = new Set();
                readSnapshot.docs.forEach(doc => {
                    readHizb.add(doc.data().hizb);
                });
                
                // Générer la grille des 60 hizb
                const grid = document.getElementById('hizb-selection-grid');
                selectedHizb = Array.from(memberCurrentHizb);
                
                grid.innerHTML = '';
                for (let i = 1; i <= 60; i++) {
                    const hizbNum = i.toString();
                    const isTaken = takenHizb.has(hizbNum);
                    const isAssignedToMember = memberCurrentHizb.has(hizbNum);
                    const isRead = readHizb.has(hizbNum);
                    
                    const div = document.createElement('div');
                    div.className = 'hizb-item';
                    
                    if (isTaken && !isAssignedToMember) {
                        // Hizb déjà attribué à un autre membre - EN ROUGE, NON SELECTIONNABLE
                        div.classList.add('taken');
                        div.innerHTML = `
                            <div class="hizb-number">Hizb ${i}</div>
                            <div class="hizb-status">Déjà attribué</div>
                        `;
                    } else if (isAssignedToMember) {
                        // Hizb déjà attribué à ce membre - EN VERT, SELECTIONNABLE
                        div.classList.add('assigned');
                        div.innerHTML = `
                            <div class="hizb-number">Hizb ${i}</div>
                            <div class="hizb-status">${isRead ? 'Déjà lu ✓' : 'Assigné'}</div>
                        `;
                        
                        if (!isRead) {
                            div.addEventListener('click', createHizbClickHandler(i));
                        }
                    } else {
                        // Hizb disponible - DISPONIBLE
                        div.classList.add('available');
                        div.innerHTML = `
                            <div class="hizb-number">Hizb ${i}</div>
                            <div class="hizb-status">Disponible</div>
                        `;
                        div.addEventListener('click', createHizbClickHandler(i));
                    }
                    
                    if (selectedHizb.includes(hizbNum)) {
                        div.classList.add('selected');
                    }
                    
                    grid.appendChild(div);
                }
                
                updateSelectedHizbDisplay();
                updateAssignButton();
                
                // Gestion du bouton d'assignation
                document.getElementById('assign-hizb-btn').onclick = assignHizbToMember;
                
            } catch (error) {
                console.error('Erreur chargement hizb:', error);
            }
        }
        
        function createHizbClickHandler(hizbNumber) {
            return function() {
                const hizbNum = hizbNumber.toString();
                const index = selectedHizb.indexOf(hizbNum);
                
                if (index === -1) {
                    // Vérifier si le hizb est disponible (pas déjà pris par un autre)
                    if (!takenHizb.has(hizbNum)) {
                        selectedHizb.push(hizbNum);
                        this.classList.add('selected');
                    }
                } else {
                    selectedHizb.splice(index, 1);
                    this.classList.remove('selected');
                }
                
                updateSelectedHizbDisplay();
                updateAssignButton();
            };
        }
        
       function updateSelectedHizbDisplay() {
    const display = document.getElementById('selected-hizb-display');
    
    if (selectedHizb.length === 0) {
        display.innerHTML = `
            <div style="color: var(--accent-color); background: rgba(155, 156, 40, 0.1); padding: 10px; border-radius: 8px; border: 2px dashed var(--accent-color);">
                <i class="fas fa-info-circle"></i> Aucun hizb sélectionné - Le membre n'aura aucun hizb assigné
            </div>
        `;
    } else {
        display.innerHTML = selectedHizb.map(hizb => `
            <div style="background: var(--accent-color); color: white; padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                Hizb ${hizb}
                <button onclick="removeHizb('${hizb}')" style="background: none; border: none; color: white; cursor: pointer; font-size: 0.8rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }
}
        
        function removeHizb(hizb) {
            const index = selectedHizb.indexOf(hizb);
            if (index !== -1) {
                selectedHizb.splice(index, 1);
                
                // Mettre à jour l'affichage de la grille
                const gridItems = document.querySelectorAll('.hizb-item');
                gridItems.forEach(item => {
                    const hizbNum = item.querySelector('.hizb-number')?.textContent.replace('Hizb ', '');
                    if (hizbNum === hizb) {
                        item.classList.remove('selected');
                    }
                });
                
                updateSelectedHizbDisplay();
                updateAssignButton();
            }
        }
        
       function updateAssignButton() {
    const btn = document.getElementById('assign-hizb-btn');
    
    // MODIFIÉ : Toujours activé, même avec 0 hizb
    if (selectedHizb.length > 0) {
        btn.innerHTML = `<i class="fas fa-check-circle"></i> Assigner ${selectedHizb.length} hizb(s)`;
        btn.disabled = false;
    } else {
        // NOUVEAU : Permettre d'enregistrer avec 0 hizb
        btn.innerHTML = `<i class="fas fa-check-circle"></i> Enregistrer (0 hizb assignés)`;
        btn.disabled = false;
    }
}
        
        // Assigner les hizb au membre
      // Assigner les hizb au membre (ou retirer tous les hizb)
async function assignHizbToMember() {
    if (!selectedMember) return;
    
    try {
        // SUPPRIMER TOUTES les anciennes assignations pour ce membre cette semaine
        const oldAssignments = await db.collection('hizbAssignments')
            .where('memberCode', '==', selectedMember.code)
            .where('week', '==', currentWeekKey)
            .get();
        
        const deletePromises = oldAssignments.docs.map(doc => doc.ref.delete());
        await Promise.all(deletePromises);
        
        // AJOUTER les nouvelles assignations SEULEMENT si selectedHizb > 0
        if (selectedHizb.length > 0) {
            const assignPromises = selectedHizb.map(hizb => 
                db.collection('hizbAssignments').add({
                    memberCode: selectedMember.code,
                    memberName: `${selectedMember.firstname} ${selectedMember.lastname}`,
                    hizb: hizb,
                    week: currentWeekKey,
                    assignedAt: new Date().toISOString(),
                    assignedBy: 'admin'
                })
            );
            
            await Promise.all(assignPromises);
            
            alertSuccess(`${selectedHizb.length} hizb assignés avec succès à ${selectedMember.firstname} ${selectedMember.lastname}`);
        } else {
            // CAS 0 HIZB : Message spécial
            alertSuccess(`Tous les hizb retirés de ${selectedMember.firstname} ${selectedMember.lastname}`);
        }
        
        // Revenir à la liste des membres
        showMembersPage();
        
    } catch (error) {
        console.error('Erreur assignation:', error);
        alertError('Erreur lors de l\'assignation des hizb');
    }
}
        
        // Charger les messages
async function loadMessages() {
    try {
        console.log('=== DÉBUT CHARGEMENT MESSAGES ===');
        
        // 1. Récupérer TOUS les membres
        const membersSnapshot = await db.collection("members").get();
        const allMembers = membersSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        })).sort((a, b) => a.code.localeCompare(b.code)); // Tri par code
        
        console.log(`${allMembers.length} membres trouvés au total`);
        
        // 2. Récupérer TOUS les messages (solution temporaire)
        let allMessages = [];
        try {
            const messagesSnapshot = await db.collection('chatMessages')
                .orderBy('timestamp', 'desc')
                .limit(200)
                .get();
            allMessages = messagesSnapshot.docs.map(doc => doc.data());
            console.log(`${allMessages.length} messages trouvés`);
        } catch (error) {
            console.warn('Erreur récupération messages (index manquant):', error.message);
        }
        
        // 3. Organiser les messages par membre
        const messagesByMember = {};
        allMessages.forEach(msg => {
            const memberCode = msg.memberCode;
            if (!messagesByMember[memberCode]) {
                messagesByMember[memberCode] = [];
            }
            messagesByMember[memberCode].push(msg);
        });
        
        // 4. Analyser CHAQUE membre
        const pendingMembers = [];   // Sans réponse admin
        const unreadMembers = [];    // Messages non lus
        const allMembersList = [];   // Tous les autres
        
       // Dans loadMessages(), modifiez la partie d'analyse des messages :
for (const member of allMembers) {
    const memberCode = member.code;
    const memberMessages = messagesByMember[memberCode] || [];
    
    console.log(`\nMembre: ${memberCode} - ${member.firstname} ${member.lastname}`);
    console.log(`Messages: ${memberMessages.length}`);
    
    if (memberMessages.length === 0) {
        allMembersList.push({
            member,
            lastMessage: null,
            unreadCount: 0,
            messageCount: 0,
            hasMemberMessages: false,
            hasAdminReply: false
        });
        continue;
    }
    
    // Analyser les messages
    const hasMemberMessages = memberMessages.some(m => m.sender === 'member');
    const hasAdminReply = memberMessages.some(m => m.sender === 'admin');
    const unreadCount = memberMessages.filter(m => m.sender === 'member' && !m.read).length;
    const lastMessage = memberMessages[0];
    
    const memberData = {
        member,
        lastMessage,
        unreadCount,
        messageCount: memberMessages.length,
        hasMemberMessages,
        hasAdminReply
    };
    
    // NOUVELLE LOGIQUE : 
    // 1. D'abord vérifier si en attente (message membre sans réponse admin)
    if (hasMemberMessages && !hasAdminReply) {
        console.log(`→ Classé: EN ATTENTE (message membre sans réponse admin)`);
        pendingMembers.push(memberData);
    } 
    // 2. Ensuite vérifier les non lus (même s'il a une réponse admin)
    else if (unreadCount > 0) {
        console.log(`→ Classé: NON LU (${unreadCount} messages non lus)`);
        unreadMembers.push(memberData);
    } 
    // 3. Le reste
    else {
        console.log(`→ Classé: RÉPONDU ou autre`);
        allMembersList.push(memberData);
    }
}
        
        console.log('\n=== RÉCAPITULATIF ===');
        console.log(`En attente: ${pendingMembers.length} membre(s)`);
        console.log(`Non lus: ${unreadMembers.length} membre(s)`);
        console.log(`Autres: ${allMembersList.length} membre(s)`);
        console.log(`Total: ${pendingMembers.length + unreadMembers.length + allMembersList.length} / ${allMembers.length}`);
        
        // 5. Afficher TOUS les membres
        const container = document.getElementById('members-chat-list');
        let html = '';
        
        // SECTION 1: Messages en attente (si existants)
        if (pendingMembers.length > 0) {
            html += createSection('pending', pendingMembers, 
                '🚨 Messages en attente de réponse', 
                'fa-exclamation-triangle', '#dc3545');
        }
        
        // SECTION 2: Messages non lus (si existants)
        if (unreadMembers.length > 0) {
            html += createSection('unread', unreadMembers, 
                '💬 Messages non lus', 
                'fa-envelope', 'var(--accent-color)');
        }
        
        // SECTION 3: TOUS les autres membres (TOUJOURS affiché)
        html += createSection('all', allMembersList, 
            `👥 Tous les membres (${allMembersList.length} membres)`, 
            'fa-users', 'var(--text-color)');
        
        container.innerHTML = html;
        
        // 6. Mettre à jour les compteurs
        const totalUnread = unreadMembers.reduce((sum, m) => sum + m.unreadCount, 0);
        const unreadBadge = document.getElementById('unread-count-badge');
        if (totalUnread > 0) {
            document.getElementById('unread-count').textContent = totalUnread;
            unreadBadge.style.display = 'flex';
        } else {
            unreadBadge.style.display = 'none';
        }
        
        console.log('=== FIN CHARGEMENT ===');
        
    } catch (error) {
        console.error('ERREUR GÉNÉRALE:', error);
        showErrorMessage(error);
    }
}

// Fonction pour créer une section - AMÉLIORÉE
function createSection(type, members, title, icon, color) {
    if (members.length === 0 && type !== 'all') {
        return ''; // Ne pas afficher les sections vides (sauf "all")
    }
    
    return `
        <div style="grid-column: 1/-1; margin-bottom: ${type === 'all' ? '10px' : '25px'};">
            <div style="
                background: ${color === '#dc3545' ? 'rgba(220, 53, 69, 0.15)' : 
                          color === 'var(--accent-color)' ? 'rgba(155, 156, 40, 0.15)' : 
                          'rgba(31, 74, 73, 0.3)'};
                border-left: 5px solid ${color};
                padding: 15px 20px;
                border-radius: 10px;
                margin-bottom: 15px;
            ">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas ${icon}" style="color: ${color}; font-size: 1.3rem;"></i>
                    <div style="flex: 1;">
                        <h3 style="color: ${color}; margin: 0; font-size: 1.2rem; font-family: 'Orbitron', sans-serif;">
                            ${title}
                        </h3>
                        <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">
                            ${members.length} membre(s)
                        </div>
                    </div>
                </div>
            </div>
            <div class="members-list-full">
                ${members.map(data => createMemberCard(data, type)).join('')}
            </div>
        </div>
    `;
}

// Fonction pour créer une carte membre - AMÉLIORÉE
// Dans createMemberCard(), ajouter un indicateur visuel
function createMemberCard(data, type) {
    const member = data.member;
    const lastMsg = data.lastMessage;
    
    // Déterminer le statut exact
    const status = getMemberStatus(data.messages || []);
    
    let badge = '';
    let statusText = '';
    let cardStyle = '';
    let indicator = '';
    
    if (type === 'pending') {
        // Même si lu, montrer comme en attente
        badge = `<div style="
            background: #dc3545; 
            color: white; 
            padding: 5px 10px; 
            border-radius: 15px; 
            font-size: 0.8rem;
            font-weight: bold;
            animation: pulse 1.5s infinite;
            display: flex;
            align-items: center;
            gap: 5px;
        ">
            <i class="fas fa-clock"></i> ${data.hasUnread ? 'Nouveau' : 'En attente'}
        </div>`;
        
        statusText = `<span style="color: #dc3545; font-weight: bold;">
            <i class="fas fa-exclamation-circle"></i> À répondre
        </span>`;
        
        cardStyle = 'border-left: 5px solid #dc3545; background: rgba(220, 53, 69, 0.1);';
        
        // Indicateur visuel supplémentaire
        indicator = `<div style="
            position: absolute;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            background: #dc3545;
            border-radius: 50%;
            animation: blink 1s infinite;
        "></div>`;
        
    } else if (type === 'unread') {
        // Messages non lus (mais admin a déjà répondu)
        badge = `<div style="
            background: var(--accent-color); 
            color: white; 
            padding: 5px 10px; 
            border-radius: 15px; 
            font-size: 0.9rem; 
            font-weight: bold;
        ">${data.unreadCount}</div>`;
        
        statusText = `<span style="color: var(--accent-color);">
            <i class="fas fa-envelope"></i> Nouveau(x) message(s)
        </span>`;
        
        cardStyle = 'border: 2px solid var(--accent-color); background: rgba(155, 156, 40, 0.05);';
        
    } else {
        // Autres cas
        if (data.hasAdminReply) {
            statusText = `<span style="color: #28a745;">
                <i class="fas fa-check-double"></i> 
            </span>`;
            badge = `<div style="color: #28a745;"><i class="fas fa-check-circle"></i></div>`;
        } else if (data.messageCount > 0) {
            statusText = `<span style="color: var(--text-muted);">
                <i class="far fa-comment"></i> Message lu (pas de réponse)
            </span>`;
            badge = `<div style="color: var(--text-muted);"><i class="far fa-comment"></i></div>`;
        } else {
            statusText = `<span style="color: var(--text-muted);">
                <i class="far fa-comment"></i> Aucun message
            </span>`;
            badge = `<div style="color: var(--text-muted);"><i class="far fa-comment"></i></div>`;
        }
    }
    
  return `
        <div class="member-chat-card" 
             onclick="openChatModal('${member.code}', '${member.firstname} ${member.lastname}')" 
             style="${cardStyle}; position: relative;">
            ${indicator}
            <div class="member-chat-header">
                <div style="flex: 1;">
                    <div class="member-chat-name">
                        ${member.firstname} ${member.lastname}
                    </div>
                    <div class="member-chat-code">Code: ${member.code}</div>
                </div>
                ${badge}
            </div>
            <div class="member-chat-lastmsg">
                ${lastMsg ? formatMessage(lastMsg.message) : 'Aucun message échangé'}
                ${lastMsg ? `
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">
                        <i class="far fa-clock"></i> ${formatTime(lastMsg.timestamp)}
                    </div>
                ` : ''}
            </div>
            <div class="member-chat-footer">
                <div style="font-size: 0.85rem;">
                    ${statusText}
                </div>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <!-- ICÔNE POUBELLE AJOUTÉE ICI -->
                    <button class="btn-trash" onclick="confirmDeleteMessages('${member.code}', '${member.firstname} ${member.lastname}', event)">
                        <i class="fas fa-trash-alt"></i>
                        ${data.messageCount > 0 ? `(${data.messageCount})` : ''}
                    </button>
                    <i class="fas fa-chevron-right" style="color: var(--accent-color);"></i>
                </div>
            </div>
        </div>
    `;
}

// Fonctions utilitaires
function formatMessage(text) {
    return text.length > 60 ? text.substring(0, 60) + '...' : text;
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
    
    if (diffHours < 24) {
        return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    } else {
        return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
    }
}

// Fonction pour afficher les erreurs
function showErrorMessage(error) {
    const container = document.getElementById('members-chat-list');
    container.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
            <div style="
                background: rgba(220, 53, 69, 0.1); 
                padding: 25px; 
                border-radius: 10px; 
                margin-bottom: 20px;
                border-left: 5px solid #dc3545;
            ">
                <h3 style="color: #dc3545; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-exclamation-triangle"></i> Erreur de chargement
                </h3>
                <div style="
                    text-align: left; 
                    background: rgba(0,0,0,0.3); 
                    padding: 15px; 
                    border-radius: 8px; 
                    margin-bottom: 15px;
                    font-family: monospace;
                    font-size: 0.9rem;
                ">
                    <strong>Message:</strong> ${error.message}
                </div>
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">
                    Ouvrez la console (F12 → Console) pour plus de détails
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="loadMessages()" class="btn-primary">
                        <i class="fas fa-redo"></i> Réessayer
                    </button>
                    <button onclick="window.location.reload()" class="btn-secondary">
                        <i class="fas fa-sync-alt"></i> Actualiser la page
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Ajouter l'animation CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    .member-chat-card {
        transition: all 0.3s ease !important;
    }
    
    .member-chat-card:hover {
        transform: translateY(-3px) !important;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3) !important;
    }
`;
document.head.appendChild(style);

// Fonction pour afficher les erreurs
function showErrorMessage(error) {
    const container = document.getElementById('members-chat-list');
    container.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
            <div style="background: rgba(220, 53, 69, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #dc3545; margin-bottom: 15px;">
                    <i class="fas fa-bug"></i> Mode Débug
                </h3>
                <div style="text-align: left; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>Erreur:</strong> ${error.message}
                </div>
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 15px;">
                    Ouvrez la console (F12) pour voir les détails
                </div>
            </div>
            <button onclick="testFirestoreConnection()" class="btn-primary" style="margin: 10px;">
                <i class="fas fa-plug"></i> Tester connexion Firestore
            </button>
            <button onclick="loadMessages()" class="btn-primary">
                <i class="fas fa-redo"></i> Réessayer
            </button>
        </div>
    `;
}

// Fonction de test
async function testFirestoreConnection() {
    try {
        const test = await db.collection('members').limit(1).get();
        alert(`✅ Connexion Firestore OK: ${test.size} document(s)`);
    } catch (error) {
        alert(`❌ Erreur Firestore: ${error.message}`);
    }
}

 

// Fonction pour formater la date relative
function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffMins < 1) return 'À l\'instant';
    if (diffMins < 60) return `Il y a ${diffMins} min`;
    if (diffHours < 24) return `Il y a ${diffHours} h`;
    if (diffDays === 1) return 'Hier';
    if (diffDays < 7) return `Il y a ${diffDays} j`;
    return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
}

// Configuration de la recherche
function setupSearch() {
    document.getElementById('messages-search').addEventListener('input', function(e) {
        const search = e.target.value.toLowerCase().trim();
        const cards = document.querySelectorAll('.member-chat-card');
        const sections = document.querySelectorAll('[style*="grid-column: 1/-1"]');
        
        let hasVisibleCards = false;
        
        cards.forEach(card => {
            const name = card.querySelector('.member-chat-name').textContent.toLowerCase();
            const code = card.querySelector('.member-chat-code').textContent.toLowerCase();
            const message = card.querySelector('.member-chat-lastmsg').textContent.toLowerCase();
            
            const matches = name.includes(search) || code.includes(search) || message.includes(search);
            
            if (matches) {
                card.style.display = 'flex';
                hasVisibleCards = true;
                
                // Afficher la section parente
                const section = card.closest('[style*="grid-column: 1/-1"]');
                if (section) {
                    section.style.display = 'block';
                }
            } else {
                card.style.display = 'none';
            }
        });
        
        // Cacher les sections vides
        sections.forEach(section => {
            const cardsInSection = section.querySelectorAll('.member-chat-card[style="display: flex;"]');
            if (cardsInSection.length === 0) {
                section.style.display = 'none';
            }
        });
    });
}
        // Ouvrir le modal de chat
async function openChatModal(memberCode, memberName) {
    try {
        // Mettre à jour l'interface
        document.getElementById('modal-member-name').textContent = memberName;
        document.getElementById('modal-member-code').textContent = memberCode;
        
        // Réinitialiser l'input
        document.getElementById('modal-chat-input').value = '';
        
        // Afficher le modal
        document.getElementById('chat-modal').style.display = 'flex';
        
        // Charger les messages
        await loadModalMessages(memberCode);
        
        // Marquer comme lus
        await markMessagesAsRead(memberCode);
        
        // Focus sur l'input
        setTimeout(() => {
            document.getElementById('modal-chat-input').focus();
        }, 500);
        
    } catch (error) {
        console.error('Erreur ouverture chat:', error);
        alertError('Impossible d\'ouvrir le chat');
    }
}

// Fermer le modal
function closeChatModal() {
    document.getElementById('chat-modal').style.display = 'none';
    // Recharger la liste pour mettre à jour les badges
    loadMessages();
}

// Charger les messages dans le modal
async function loadModalMessages(memberCode) {
    try {
        const container = document.getElementById('modal-messages-container');
        
        // Solution temporaire - Récupérer TOUS les messages puis filtrer
        const snapshot = await db.collection('chatMessages')
            .orderBy('timestamp', 'asc')
            .limit(200)
            .get();
        
        // Filtrer côté client en attendant l'index
        const filteredMessages = snapshot.docs
            .filter(doc => doc.data().memberCode === memberCode);
        
        if (filteredMessages.length === 0) {
            container.innerHTML = `
                <div class="no-messages">
                    <i class="fas fa-comment-slash"></i>
                    <div style="font-size: 1.2rem; margin-bottom: 10px;">Aucun message échangé</div>
                    <div style="color: var(--text-muted);">Commencez la conversation !</div>
                </div>
            `;
            setupChatInputs(memberCode);
            return;
        }
        
        container.innerHTML = '';
        
        filteredMessages.forEach(doc => {
            const msg = doc.data();
            // ... (le reste du code reste identique)
        });
        
        // ... (le reste du code reste identique)
        
      // Grouper les messages par date
const groupedMessages = {};
snapshot.docs.forEach(doc => {
    const msg = doc.data();
    const date = new Date(msg.timestamp);
    const dateKey = date.toLocaleDateString('fr-FR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    if (!groupedMessages[dateKey]) {
        groupedMessages[dateKey] = [];
    }
    groupedMessages[dateKey].push(msg);
});

// Afficher les messages groupés par date
Object.entries(groupedMessages).forEach(([date, msgs]) => {
    // Ajouter séparateur de date
    const dateSeparator = document.createElement('div');
    dateSeparator.className = 'date-separator';
    dateSeparator.innerHTML = `<span>${date}</span>`;
    container.appendChild(dateSeparator);
    
    // Ajouter les messages de cette date
    msgs.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message-modal-item ${msg.sender === 'member' ? 'message-modal-member' : 'message-modal-admin'}`;
        
        const time = new Date(msg.timestamp);
        const timeString = time.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
        
        messageDiv.innerHTML = `
            <div style="font-size: 1.05rem; line-height: 1.5; padding: 12px 15px;">${escapeHtml(msg.message)}</div>
            <div class="message-modal-time">${timeString}</div>
        `;
        
        container.appendChild(messageDiv);
    });
});
        
        // Scroll vers le bas
        container.scrollTop = container.scrollHeight;
        
        // Configurer les événements
        setupChatInputs(memberCode);
        
    } catch (error) {
        console.error('Erreur chargement messages modal:', error);
        const container = document.getElementById('modal-messages-container');
        container.innerHTML = `
            <div class="no-messages" style="color: #dc3545;">
                <i class="fas fa-exclamation-triangle"></i>
                <div style="font-size: 1.2rem; margin-bottom: 10px;">Erreur de chargement</div>
                <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 15px;">
                    ${error.message || 'Veuillez réessayer'}
                </div>
                <button onclick="retryLoadMessages('${memberCode}')" class="btn-primary" style="margin-top: 10px;">
                    <i class="fas fa-redo"></i> Réessayer
                </button>
            </div>
        `;
    }
}

  // Fonction pour marquer les messages comme lus (modifiée)
async function markMessagesAsRead(memberCode) {
    try {
        console.log(`Marquage messages comme lus pour: ${memberCode}`);
        
        // Récupérer tous les messages non lus de ce membre
        const snapshot = await db.collection('chatMessages')
            .where('memberCode', '==', memberCode)
            .where('read', '==', false)
            .where('sender', '==', 'member')
            .get();
        
        console.log(`${snapshot.size} messages à marquer comme lus`);
        
        // Marquer comme lus MAIS garder la trace
        const updatePromises = snapshot.docs.map(doc => 
            doc.ref.update({ 
                read: true,
                readAt: new Date().toISOString() // Ajouter timestamp de lecture
            })
        );
        
        await Promise.all(updatePromises);
        console.log('Messages marqués comme lus');
        
        // NE PAS recharger immédiatement pour garder l'affichage
        // Attendre que l'admin réponde pour enlever de "en attente"
        
    } catch (error) {
        console.error('Erreur marquage messages:', error);
    }
}

// Modifier openChatModal pour appeler cette fonction
async function openChatModal(memberCode, memberName) {
    try {
        document.getElementById('modal-member-name').textContent = memberName;
        document.getElementById('modal-member-code').textContent = memberCode;
        document.getElementById('modal-chat-input').value = '';
        
        document.getElementById('chat-modal').style.display = 'flex';
        await loadModalMessages(memberCode);
        
        // Marquer comme lus MAIS garder en attente si pas de réponse
        await markMessagesAsRead(memberCode);
        
        setTimeout(() => {
            document.getElementById('modal-chat-input').focus();
        }, 500);
        
    } catch (error) {
        console.error('Erreur ouverture chat:', error);
        alertError('Impossible d\'ouvrir le chat');
    }
}
      
      // Fonction pour déterminer le statut
function getMemberStatus(memberMessages) {
    const hasMemberMessages = memberMessages.some(m => m.sender === 'member');
    const hasAdminReply = memberMessages.some(m => m.sender === 'admin');
    const hasUnreadMessages = memberMessages.some(m => m.sender === 'member' && !m.read);
    const lastMessage = memberMessages[0];
    const lastMessageFromMember = memberMessages.find(m => m.sender === 'member');
    const lastMessageFromAdmin = memberMessages.find(m => m.sender === 'admin');
    
    // Si le membre a envoyé un message mais que l'admin n'a jamais répondu
    // → TOUJOURS en attente (peu importe si lu ou non)
    if (hasMemberMessages && !hasAdminReply) {
        return {
            type: 'pending',
            priority: 1, // Haute priorité
            message: 'En attente de réponse',
            data: {
                lastMessage,
                unreadCount: hasUnreadMessages ? 1 : 0,
                hasUnread: hasUnreadMessages,
                lastMemberMessage: lastMessageFromMember,
                lastAdminMessage: null
            }
        };
    }
    
    // Si admin a répondu mais il y a des nouveaux messages non lus
    if (hasUnreadMessages) {
        const unreadCount = memberMessages.filter(m => m.sender === 'member' && !m.read).length;
        return {
            type: 'unread',
            priority: 2, // Moyenne priorité
            message: `${unreadCount} message(s) non lu(s)`,
            data: {
                lastMessage,
                unreadCount,
                hasUnread: true,
                lastMemberMessage: lastMessageFromMember,
                lastAdminMessage: lastMessageFromAdmin
            }
        };
    }
    
    // Si conversation terminée (admin a répondu à tout)
    if (hasAdminReply && hasMemberMessages) {
        return {
            type: 'replied',
            priority: 3,
            message: 'Répondu',
            data: {
                lastMessage,
                unreadCount: 0,
                hasUnread: false,
                lastMemberMessage: lastMessageFromMember,
                lastAdminMessage: lastMessageFromAdmin
            }
        };
    }
    
    // Aucun message
    return {
        type: 'none',
        priority: 4,
        message: 'Aucun message',
        data: {
            lastMessage: null,
            unreadCount: 0,
            hasUnread: false,
            lastMemberMessage: null,
            lastAdminMessage: null
        }
    };
}
// Fonction pour configurer les inputs du chat
function setupChatInputs(memberCode) {
    const memberName = document.getElementById('modal-member-name').textContent;
    const sendBtn = document.getElementById('modal-send-btn');
    const input = document.getElementById('modal-chat-input');
    
    sendBtn.onclick = () => sendModalMessage(memberCode, memberName);
    input.onkeypress = function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendModalMessage(memberCode, memberName);
        }
    };
}

// Fonction pour réessayer
function retryLoadMessages(memberCode) {
    loadModalMessages(memberCode);
}

// Envoyer un message depuis le modal
async function sendModalMessage(memberCode, memberName) {
    const input = document.getElementById('modal-chat-input');
    const message = input.value.trim();
    
    if (!message) {
        alertError('Veuillez écrire un message');
        return;
    }
    
    const sendBtn = document.getElementById('modal-send-btn');
    const originalText = sendBtn.innerHTML;
    
    try {
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        await db.collection('chatMessages').add({
            memberCode: memberCode,
            memberName: memberName,
            message: message,
            timestamp: new Date().toISOString(),
            sender: 'admin',
            read: true
        });
        
        input.value = '';
        await loadModalMessages(memberCode);
        // Limiter à 10 messages
await limitMessages(memberCode);
    } catch (error) {
        console.error('Erreur envoi message modal:', error);
        alertError('Erreur lors de l\'envoi');
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
        input.focus();
    }
}

// Fonction pour marquer les messages comme lus (gardez celle existante)
async function markMessagesAsRead(memberCode) {
    try {
        const snapshot = await db.collection('chatMessages')
            .where('memberCode', '==', memberCode)
            .where('read', '==', false)
            .where('sender', '==', 'member')
            .get();
        
        const updatePromises = snapshot.docs.map(doc => 
            doc.ref.update({ read: true })
        );
        
        await Promise.all(updatePromises);
    } catch (error) {
        console.error('Erreur marquage messages:', error);
    }
}
        // Ouvrir le chat avec un membre
       // Ouvrir le chat avec un membre - VERSION AMÉLIORÉE
async function openChatWithMember(memberCode, memberName) {
    // Retirer la sélection précédente
    const previousSelected = document.querySelector('.member-item.selected');
    if (previousSelected) {
        previousSelected.classList.remove('selected');
    }
    
    // Ajouter la sélection au membre cliqué
    const items = document.querySelectorAll('.member-item');
    items.forEach(item => {
        if (item.textContent.includes(memberName)) {
            item.classList.add('selected');
        }
    });
    
    chatMember = { code: memberCode, name: memberName };
    document.getElementById('chat-member-name').textContent = memberName;
    document.getElementById('chat-main').style.display = 'flex';
    document.getElementById('chat-placeholder').style.display = 'none';
    
    await loadChatMessages(memberCode);
    
    // Marquer les messages comme lus
    await markMessagesAsRead(memberCode);
    
    // Focus sur l'input
    document.getElementById('admin-chat-input').focus();
}
        
        // Charger les messages de chat
      // Charger les messages de chat - VERSION AMÉLIORÉE
async function loadChatMessages(memberCode) {
    try {
        const snapshot = await db.collection('chatMessages')
            .where('memberCode', '==', memberCode)
            .orderBy('timestamp', 'asc')
            .limit(100)
            .get();
        
        const container = document.getElementById('admin-chat-messages');
        container.innerHTML = '';
        
        if (snapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <i class="fas fa-comment-slash" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <div>Aucun message avec ce membre</div>
                    <div style="font-size: 0.9rem; margin-top: 10px;">
                        Commencez la conversation en envoyant un message
                    </div>
                </div>
            `;
            return;
        }
        
      snapshot.docs.forEach(doc => {
    const msg = doc.data();
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-modal-item ${msg.sender === 'member' ? 'message-modal-member' : 'message-modal-admin'}`;
    
    const time = new Date(msg.timestamp);
    const timeString = time.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
    const dateString = time.toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit', year: 'numeric'});
    
    // Format WhatsApp/Télégram
    messageDiv.innerHTML = `
        <div style="font-size: 1.05rem; line-height: 1.5; padding: 12px 15px;">${escapeHtml(msg.message)}</div>
        <div class="message-modal-time">${timeString}</div>
    `;
    
    container.appendChild(messageDiv);
});
        
        // Scroll automatique vers le bas
        container.scrollTop = container.scrollHeight;
        
        // Gestion de l'envoi améliorée
        const sendBtn = document.getElementById('admin-send-btn');
        const input = document.getElementById('admin-chat-input');
        
        sendBtn.onclick = sendAdminMessage;
        input.onkeypress = function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAdminMessage();
            }
        };
        
        // Focus automatique sur l'input
        input.focus();
        
    } catch (error) {
        console.error('Erreur chargement chat:', error);
        const container = document.getElementById('admin-chat-messages');
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #dc3545;">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <div>Erreur de chargement de la conversation</div>
            </div>
        `;
    }
}
        
        // Envoyer un message en tant qu'admin
       // Envoyer un message en tant qu'admin - VERSION AMÉLIORÉE
async function sendAdminMessage() {
    if (!chatMember) {
        alertError('Aucun membre sélectionné');
        return;
    }
    
    const input = document.getElementById('admin-chat-input');
    const message = input.value.trim();
    
    if (!message) {
        alertError('Veuillez écrire un message');
        input.focus();
        return;
    }
    
    const sendBtn = document.getElementById('admin-send-btn');
    const originalText = sendBtn.innerHTML;
    
    try {
        // Désactiver le bouton pendant l'envoi
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Envoi...';
        
        await db.collection('chatMessages').add({
            memberCode: chatMember.code,
            memberName: chatMember.name,
            message: message,
            timestamp: new Date().toISOString(),
            sender: 'admin',
            read: true
        });
        
        // Réinitialiser l'input
        input.value = '';
        
        // Recharger les messages
        await loadChatMessages(chatMember.code);
        
        // Recharger la sidebar pour mettre à jour le dernier message
        await loadMessages();
        
    } catch (error) {
        console.error('Erreur envoi message:', error);
        alertError('Erreur lors de l\'envoi du message');
    } finally {
        // Réactiver le bouton
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
        input.focus();
    }
}
        
        // Marquer les messages comme lus
        async function markMessagesAsRead(memberCode) {
            try {
                const snapshot = await db.collection('chatMessages')
                    .where('memberCode', '==', memberCode)
                    .where('read', '==', false)
                    .where('sender', '==', 'member')
                    .get();
                
                const updatePromises = snapshot.docs.map(doc => 
                    doc.ref.update({ read: true })
                );
                
                await Promise.all(updatePromises);
                loadMessages(); // Recharger la sidebar
            } catch (error) {
                console.error('Erreur marquage messages:', error);
            }
        }
        
        // Charger la progression
       // Charger la progression - VERSION CORRIGÉE
async function loadProgress() {
    try {
        console.log('=== DÉBUT CHARGEMENT PROGRESSION ===');
        
        // Récupérer toutes les assignations de la semaine
        const [assignmentsSnapshot, readSnapshot] = await Promise.all([
            db.collection('hizbAssignments').where('week', '==', currentWeekKey).get(),
            db.collection('hizbReadStatus').where('week', '==', currentWeekKey).get()
        ]);
        
        console.log(`${assignmentsSnapshot.size} assignations trouvées`);
        console.log(`${readSnapshot.size} hizb lus trouvés`);
        
        const assignedHizb = new Map();
        assignmentsSnapshot.docs.forEach(doc => {
            const data = doc.data();
            assignedHizb.set(data.hizb, {
                memberName: data.memberName,
                memberCode: data.memberCode,
                assignedAt: data.assignedAt
            });
        });
        
        const readHizb = new Map();
        readSnapshot.docs.forEach(doc => {
            const data = doc.data();
            readHizb.set(data.hizb, {
                readAt: data.readAt,
                markedBy: data.markedBy,
                memberCode: data.memberCode
            });
        });
        
        // Statistiques
        const totalAssigned = assignedHizb.size;
        const totalRead = readHizb.size;
        const percentage = totalAssigned > 0 ? Math.round((totalRead / totalAssigned) * 100) : 0;
        
        // Mettre à jour les statistiques du dashboard
        const progressStats = document.getElementById('progress-stats');
        if (progressStats) {
            progressStats.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <div><i class="fas fa-check-circle" style="color: #28a745;"></i> ${totalRead} hizb lus</div>
                    <div><i class="fas fa-clock" style="color: #dc3545;"></i> ${totalAssigned - totalRead} en attente</div>
                    <div><i class="fas fa-percentage" style="color: var(--accent-color);"></i> ${percentage}% complété</div>
                </div>
            `;
        }
        
        // Mettre à jour les statistiques de la page progression
        const statsContainer = document.getElementById('progress-stats-container');
        statsContainer.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-book-quran" style="font-size: 2rem; color: var(--accent-color);"></i>
                    <div class="stat-value">${totalAssigned}/60</div>
                    <div class="stat-label">Hizb assignés</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle" style="font-size: 2rem; color: #28a745;"></i>
                    <div class="stat-value">${totalRead}</div>
                    <div class="stat-label">Hizb lus</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-percentage" style="font-size: 2rem; color: var(--accent-color);"></i>
                    <div class="stat-value">${percentage}%</div>
                    <div class="stat-label">Progression</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock" style="font-size: 2rem; color: #dc3545;"></i>
                    <div class="stat-value">${totalAssigned - totalRead}</div>
                    <div class="stat-label">En attente</div>
                </div>
            </div>
        `;
        
        // Générer la grille de progression
        const grid = document.getElementById('progress-grid');
        grid.innerHTML = '';
        
        for (let i = 1; i <= 60; i++) {
            const hizbNum = i.toString();
            const hizbInfo = assignedHizb.get(hizbNum);
            const readInfo = readHizb.get(hizbNum);
            
            const div = document.createElement('div');
            div.className = 'progress-item';
            
            if (hizbInfo) {
                const isRead = readInfo !== undefined && readInfo.memberCode === hizbInfo.memberCode;
                
                if (isRead) {
                    div.classList.add('read');
                } else {
                    div.classList.add('unread');
                }
                
                // CRITIQUE : Utiliser les fonctions qui rechargent après action
                div.innerHTML = `
                    <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 8px;">Hizb ${i}</div>
                    <div style="font-size: 0.8rem; margin-bottom: 10px; min-height: 40px;">${hizbInfo.memberName}</div>
                    
                    ${isRead ? 
                        `<div style="font-size: 0.7rem; margin-bottom: 10px; color: #28a745;">
                            <i class="fas fa-check-circle"></i> Marqué comme lu
                        </div>
                        <div style="display: flex; gap: 5px; justify-content: center;">
                            <button onclick="markHizbAsUnread('${hizbInfo.memberCode}', '${hizbNum}', event)" 
                                    class="hizb-button-small btn-mark-unread">
                                <i class="fas fa-times"></i> Non lu
                            </button>
                            <button onclick="openChatWithMember('${hizbInfo.memberCode}', '${hizbInfo.memberName}', event)" 
                                    class="hizb-button-small btn-chat">
                                <i class="fas fa-comment"></i> Chat
                            </button>
                        </div>` : 
                        `<div style="font-size: 0.7rem; margin-bottom: 10px; color: #dc3545;">
                            <i class="fas fa-clock"></i> Non encore lu
                        </div>
                        <div style="display: flex; gap: 5px; justify-content: center;">
                            <button onclick="markHizbAsReadByAdmin('${hizbInfo.memberCode}', '${hizbNum}', event)" 
                                    class="hizb-button-small btn-mark-read">
                                <i class="fas fa-check"></i> Marquer lu
                            </button>
                            <button onclick="openChatWithMember('${hizbInfo.memberCode}', '${hizbInfo.memberName}', event)" 
                                    class="hizb-button-small btn-chat">
                                <i class="fas fa-comment"></i> Chat
                            </button>
                        </div>`
                    }
                `;
            } else {
                div.classList.add('unassigned');
                div.innerHTML = `
                    <div style="font-weight: bold; font-size: 1.1rem; opacity: 0.5;">Hizb ${i}</div>
                    <div style="font-size: 0.8rem; margin-top: 8px; opacity: 0.5;">Non assigné</div>
                `;
            }
            
            grid.appendChild(div);
        }
        
        console.log('=== FIN CHARGEMENT PROGRESSION ===');
        
    } catch (error) {
        console.error('Erreur chargement progression:', error);
        const grid = document.getElementById('progress-grid');
        grid.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <div>Erreur de chargement de la progression</div>
                <button onclick="loadProgress()" class="btn-primary" style="margin-top: 15px;">
                    <i class="fas fa-redo"></i> Réessayer
                </button>
            </div>
        `;
    }
}
// Fonction pour regrouper les messages par date
function groupMessagesByDate(messages) {
    const grouped = {};
    
    messages.forEach(msg => {
        const date = new Date(msg.timestamp);
        const dateKey = date.toLocaleDateString('fr-FR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        if (!grouped[dateKey]) {
            grouped[dateKey] = [];
        }
        grouped[dateKey].push(msg);
    });
    
    return grouped;
}        
        // Ouvrir le chat ou changer le statut de lecture
// Ouvrir le chat ou changer le statut de lecture
// SUPPRIMEZ la fonction openChatOrToggleReadStatus() complète
// Et créez ces 2 fonctions simples :

// Fonction pour ouvrir le chat avec un membre
async function openChatWithMember(memberCode, memberName, event) {
    if (event) {
        event.stopPropagation();
    }
    
    // Ouvrir le modal de chat
    await openChatModal(memberCode, memberName);
}

// Fonction pour marquer comme lu (admin)
// Fonction pour marquer comme lu (admin)
async function markHizbAsReadByAdmin(memberCode, hizb, event) {
    if (event) {
        event.stopPropagation();
    }
    
    try {
        // Vérifier si déjà marqué comme lu
        const existing = await db.collection('hizbReadStatus')
            .where('memberCode', '==', memberCode)
            .where('hizb', '==', hizb)
            .where('week', '==', currentWeekKey)
            .get();
        
        if (!existing.empty) {
            alertInfo('Ce hizb est déjà marqué comme lu');
            return;
        }
        
        await db.collection('hizbReadStatus').add({
            memberCode: memberCode,
            hizb: hizb,
            week: currentWeekKey,
            readAt: new Date().toISOString(),
            status: 'read',
            markedBy: 'admin'
        });
        
        alertSuccess(`Hizb ${hizb} marqué comme lu avec succès`);
        
        // IMPORTANT : Recharger la progression après l'action
        loadProgress();
        
    } catch (error) {
        console.error('Erreur marquage hizb:', error);
        alertError('Erreur lors du marquage du hizb');
    }
}

// Fonction pour marquer comme non lu
async function markHizbAsUnread(memberCode, hizb, event) {
    if (event) {
        event.stopPropagation();
    }
    
    try {
        const snapshot = await db.collection('hizbReadStatus')
            .where('memberCode', '==', memberCode)
            .where('hizb', '==', hizb)
            .where('week', '==', currentWeekKey)
            .get();
        
        const deletePromises = snapshot.docs.map(doc => doc.ref.delete());
        await Promise.all(deletePromises);
        
        alertSuccess(`Hizb ${hizb} marqué comme non lu`);
        
        // IMPORTANT : Recharger la progression après l'action
        loadProgress();
        
    } catch (error) {
        console.error('Erreur annulation lecture:', error);
        alertError('Erreur lors de l\'annulation');
    }
}
        
        // Marquer un hizb comme lu par l'admin
        async function markHizbAsReadByAdmin(memberCode, hizb) {
            try {
                // Vérifier si déjà marqué comme lu
                const existing = await db.collection('hizbReadStatus')
                    .where('memberCode', '==', memberCode)
                    .where('hizb', '==', hizb)
                    .where('week', '==', currentWeekKey)
                    .get();
                
                if (!existing.empty) {
                    alertInfo('Ce hizb est déjà marqué comme lu');
                    return;
                }
                
                await db.collection('hizbReadStatus').add({
                    memberCode: memberCode,
                    hizb: hizb,
                    week: currentWeekKey,
                    readAt: new Date().toISOString(),
                    status: 'read',
                    markedBy: 'admin'
                });
                
                alertSuccess(`Hizb ${hizb} marqué comme lu avec succès`);
                
            } catch (error) {
                console.error('Erreur marquage hizb:', error);
                alertError('Erreur lors du marquage du hizb');
            }
        }
        
        // Marquer un hizb comme non lu
        async function markHizbAsUnread(memberCode, hizb) {
            try {
                const snapshot = await db.collection('hizbReadStatus')
                    .where('memberCode', '==', memberCode)
                    .where('hizb', '==', hizb)
                    .where('week', '==', currentWeekKey)
                    .get();
                
                const deletePromises = snapshot.docs.map(doc => doc.ref.delete());
                await Promise.all(deletePromises);
                
                alertSuccess(`Hizb ${hizb} marqué comme non lu`);
                
            } catch (error) {
                console.error('Erreur annulation lecture:', error);
                alertError('Erreur lors de l\'annulation');
            }
        }
        
        // Rafraîchir toutes les données
        function refreshAllData() {
            const btn = document.getElementById('refresh-btn');
            btn.classList.add('refreshing');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualisation...';
            
            setTimeout(async () => {
                try {
                    if (document.getElementById('dashboard-page').style.display !== 'none') {
                        await loadDashboardData();
                    } else if (document.getElementById('members-page').style.display !== 'none') {
                        await loadMembersList();
                    } else if (document.getElementById('messages-page').style.display !== 'none') {
                        await loadMessages();
                    } else if (document.getElementById('progress-page').style.display !== 'none') {
                        await loadProgress();
                    }
                    
                    alertSuccess('Données actualisées avec succès');
                } catch (error) {
                    alertError('Erreur lors de l\'actualisation');
                } finally {
                    btn.classList.remove('refreshing');
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i>  ';
                }
            }, 1000);
        }
        
        // Gestion de l'historique
        function showHistoryModal() {
            document.getElementById('history-modal').style.display = 'flex';
            loadHistory();
        }
        
        function closeHistoryModal() {
            document.getElementById('history-modal').style.display = 'none';
        }
        
        async function loadHistory() {
            try {
                // Récupérer toutes les semaines avec assignations
                const snapshot = await db.collection('hizbAssignments')
                    .orderBy('assignedAt', 'desc')
                    .limit(100)
                    .get();
                
                const weeksMap = new Map();
                
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const week = data.week.replace('semaine_', '');
                    if (!weeksMap.has(week)) {
                        weeksMap.set(week, []);
                    }
                    weeksMap.get(week).push(data);
                });
                
                // Récupérer les statuts de lecture
                const readSnapshot = await db.collection('hizbReadStatus')
                    .orderBy('readAt', 'desc')
                    .limit(100)
                    .get();
                
                const readMap = new Map();
                readSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const week = data.week.replace('semaine_', '');
                    if (!readMap.has(week)) {
                        readMap.set(week, []);
                    }
                    readMap.get(week).push(data);
                });
                
                // Afficher l'historique
                const container = document.getElementById('history-content');
                container.innerHTML = Array.from(weeksMap.entries()).map(([week, assignments]) => {
                    const weekReads = readMap.get(week) || [];
                    const readCount = weekReads.length;
                    
                    return `
                        <div style="margin-bottom: 25px; padding: 20px; background: rgba(31, 74, 73, 0.3); border-radius: 10px; border-left: 4px solid var(--accent-color);">
                            <h4 style="color: var(--accent-color); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                                <span>${week}</span>
                                <span style="font-size: 0.9rem; color: var(--text-muted);">
                                    ${readCount}/${assignments.length} lus
                                </span>
                            </h4>
                            <div style="font-size: 0.9rem;">
                                ${assignments.map(a => {
                                    const isRead = weekReads.some(r => r.hizb === a.hizb && r.memberCode === a.memberCode);
                                    return `
                                        <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <span style="color: ${isRead ? '#28a745' : 'white'}">${a.memberName}</span>
                                                <span style="color: var(--text-muted); margin-left: 10px;">Hizb ${a.hizb}</span>
                                            </div>
                                            <span style="color: ${isRead ? '#28a745' : '#dc3545'}; font-size: 0.8rem;">
                                                ${isRead ? '✓ Lu' : 'Non lu'}
                                            </span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Recherche
                document.getElementById('history-search').addEventListener('input', function(e) {
                    const search = e.target.value.toLowerCase();
                    const items = document.querySelectorAll('#history-content > div');
                    items.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        item.style.display = text.includes(search) ? 'block' : 'none';
                    });
                });
                
            } catch (error) {
                console.error('Erreur chargement historique:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <div>Erreur de chargement de l'historique</div>
                    </div>
                `;
            }
        }
        
        // Fonctions utilitaires
        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function alertSuccess(message) {
            showAlert(message, 'success');
        }
        
        function alertError(message) {
            showAlert(message, 'error');
        }
        
        function alertInfo(message) {
            showAlert(message, 'info');
        }
        
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 10px;
                color: white;
                z-index: 3000;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            `;
            
            if (type === 'success') {
                alert.style.background = 'linear-gradient(135deg, #28a745, #1e7e34)';
                alert.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            } else if (type === 'error') {
                alert.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
                alert.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            } else {
                alert.style.background = 'linear-gradient(135deg, var(--accent-color), var(--secondary-color))';
                alert.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            }
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 3000);
        }
      // Variables pour la suppression
let memberToDelete = null;

// Fonction pour confirmer la suppression
function confirmDeleteMessages(memberCode, memberName, event) {
    if (event) {
        event.stopPropagation(); // Empêche l'ouverture du chat
    }
    
    memberToDelete = { code: memberCode, name: memberName };
    
    // Mettre à jour le texte du modal
    document.getElementById('member-to-delete-name').textContent = memberName;
    
    // Afficher le modal
    document.getElementById('delete-confirmation-modal').style.display = 'flex';
    
    // Configurer les boutons
    document.getElementById('confirm-delete-btn').onclick = () => deleteAllMessagesV2(memberCode);

    document.getElementById('cancel-delete-btn').onclick = closeDeleteModal;
    
    // Fermer en cliquant en dehors
    document.getElementById('delete-confirmation-modal').onclick = function(e) {
        if (e.target.id === 'delete-confirmation-modal') {
            closeDeleteModal();
        }
    };
}

// Fonction pour fermer le modal
function closeDeleteModal() {
    document.getElementById('delete-confirmation-modal').style.display = 'none';
    memberToDelete = null;
}

// Fonction principale pour supprimer tous les messages
// FONCTION CORRIGÉE POUR SUPPRIMER LES MESSAGES
async function deleteAllMessagesV2(memberCode) {
    const deleteBtn = document.getElementById('confirm-delete-btn');
    const originalText = deleteBtn.innerHTML;
    
    try {
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Recherche...';
        
        console.log(`Début suppression messages pour: ${memberCode}`);
        
        // Méthode DIRECTE et SIMPLE
        const messagesRef = db.collection('chatMessages');
        
        // OPTION 1: Essayer avec where (recommandé)
        let query = messagesRef.where('memberCode', '==', memberCode);
        const snapshot = await query.get();
        
        console.log(`${snapshot.size} messages trouvés`);
        
        if (snapshot.size === 0) {
            closeDeleteModal();
            alertInfo('Aucun message à supprimer');
            return;
        }
        
        // Supprimer en BATCH
        deleteBtn.innerHTML = `<i class="fas fa-trash"></i> Suppression (${snapshot.size})...`;
        
        const batch = db.batch();
        snapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        console.log(`${snapshot.size} messages supprimés avec succès`);
        
        // SUCCÈS
        closeDeleteModal();
        alertSuccess(`✅ ${snapshot.size} messages supprimés !`);
        
        // Recharger IMMÉDIATEMENT
        setTimeout(() => {
            loadMessages();
            
            // Fermer le chat si ouvert
            const currentMemberCode = document.getElementById('modal-member-code')?.textContent;
            if (currentMemberCode === memberCode) {
                closeChatModal();
            }
        }, 300);
        
    } catch (error) {
        console.error('ERREUR SUPPRESSION:', error);
        
        // Méthode de secours
        try {
            alertInfo('Méthode alternative...');
            
            // Récupérer TOUS les messages et filtrer
            const allMessages = await db.collection('chatMessages').get();
            const memberMessages = [];
            
            allMessages.docs.forEach(doc => {
                if (doc.data().memberCode === memberCode) {
                    memberMessages.push(doc);
                }
            });
            
            if (memberMessages.length > 0) {
                const batch = db.batch();
                memberMessages.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                closeDeleteModal();
                alertSuccess(`✅ ${memberMessages.length} messages supprimés (méthode alternative)`);
                
                setTimeout(() => {
                    loadMessages();
                    if (document.getElementById('modal-member-code')?.textContent === memberCode) {
                        closeChatModal();
                    }
                }, 300);
            }
            
        } catch (fallbackError) {
            console.error('ERREUR MÉTHODE ALTERNATIVE:', fallbackError);
            alertError(`Échec: ${fallbackError.message}`);
            closeDeleteModal();
        }
        
    } finally {
        if (deleteBtn) {
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = originalText;
        }
    }
}

// FALLBACK - Méthode encore plus rapide (une seule requête si possible)
async function tryFallbackDelete(memberCode) {
    try {
        // Récupérer seulement 500 messages max (assez pour la plupart)
        const snapshot = await db.collection('chatMessages')
            .where('memberCode', '==', memberCode)
            .limit(500)
            .get();
        
        if (snapshot.empty) {
            closeDeleteModal();
            return;
        }
        
        // Supprimer en UN SEUL lot
        const batch = db.batch();
        snapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        closeDeleteModal();
        alertSuccess(`✅ ${snapshot.size} messages supprimés !`);
        loadMessages();
        
    } catch (error) {
        alertError('Erreur finale: ' + error.message);
        closeDeleteModal();
    }
}

// Fonction rapide pour supprimer sans modal (optionnel)
async function quickDeleteMessages(memberCode) {
    if (!confirm("Supprimer tous les messages de ce membre ? Cette action est irréversible.")) {
        return;
    }
    
    try {
        // Récupérer et supprimer les messages
        const snapshot = await db.collection('chatMessages')
            .where('memberCode', '==', memberCode)
            .get();
        
        if (snapshot.empty) {
            alertInfo('Aucun message à supprimer');
            return;
        }
        
        const batch = db.batch();
        snapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        alertSuccess(`${snapshot.size} messages supprimés !`);
        loadMessages(); // Recharger
        
    } catch (error) {
        console.error('Erreur suppression rapide:', error);
        alertError('Erreur: ' + error.message);
    }
}
      
      
      // Fonction pour confirmer la réinitialisation
function confirmResetAllProgress() {
    // Afficher le modal
    document.getElementById('reset-confirmation-modal').style.display = 'flex';
    
    // Réinitialiser la checkbox
    document.getElementById('confirm-reset-checkbox').checked = false;
    document.getElementById('confirm-reset-btn').disabled = true;
    
    // Gérer la checkbox
    document.getElementById('confirm-reset-checkbox').onchange = function() {
        document.getElementById('confirm-reset-btn').disabled = !this.checked;
    };
    
    // Configurer les boutons
    document.getElementById('confirm-reset-btn').onclick = resetAllProgress;
    document.getElementById('cancel-reset-btn').onclick = closeResetModal;
    
    // Fermer en cliquant en dehors
    document.getElementById('reset-confirmation-modal').onclick = function(e) {
        if (e.target.id === 'reset-confirmation-modal') {
            closeResetModal();
        }
    };
}

// Fonction pour fermer le modal
function closeResetModal() {
    document.getElementById('reset-confirmation-modal').style.display = 'none';
}

// FONCTION PRINCIPALE DE RÉINITIALISATION - VERSION ULTRA-RAPIDE
async function resetAllProgress() {
    const resetBtn = document.getElementById('confirm-reset-btn');
    const originalText = resetBtn.innerHTML;
    
    try {
        // Désactiver le bouton et afficher le chargement
        resetBtn.disabled = true;
        resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> RÉINITIALISATION...';
        
        console.log('=== DÉBUT RÉINITIALISATION ===');
        
        // ÉTAPE 1: Récupérer tous les hizb lus de la semaine actuelle
        const readSnapshot = await db.collection('hizbReadStatus')
            .where('week', '==', currentWeekKey)
            .get();
        
        const totalToDelete = readSnapshot.size;
        console.log(`${totalToDelete} hizb à réinitialiser`);
        
        if (totalToDelete === 0) {
            closeResetModal();
            alertInfo('Aucun hizb à réinitialiser - déjà à zéro !');
            return;
        }
        
        // ÉTAPE 2: Supprimer en lots (plus rapide)
        const batch = db.batch();
        readSnapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        // Exécuter la suppression
        await batch.commit();
        
        console.log('=== RÉINITIALISATION TERMINÉE ===');
        
        // Afficher confirmation
        closeResetModal();
        alertSuccess(`✅ RÉINITIALISATION COMPLÈTE ! ${totalToDelete} hizb remis à zéro`);
        
        // ÉTAPE 3: Recharger immédiatement la progression
        setTimeout(() => {
            loadProgress();
            // Rafraîchir aussi le dashboard
            loadDashboardData();
        }, 500);
        
    } catch (error) {
        console.error('ERREUR RÉINITIALISATION:', error);
        
        // Essayer une méthode alternative si la première échoue
        try {
            alertError('Erreur lors de la réinitialisation. Méthode alternative...');
            
            // Méthode alternative : supprimer un par un (plus lent mais fiable)
            const altSnapshot = await db.collection('hizbReadStatus')
                .where('week', '==', currentWeekKey)
                .get();
            
            let deleted = 0;
            for (const doc of altSnapshot.docs) {
                await doc.ref.delete();
                deleted++;
            }
            
            closeResetModal();
            alertSuccess(`✅ ${deleted} hizb réinitialisés (méthode alternative)`);
            
            // Recharger
            setTimeout(() => {
                loadProgress();
                loadDashboardData();
            }, 500);
            
        } catch (altError) {
            console.error('ERREUR MÉTHODE ALTERNATIVE:', altError);
            closeResetModal();
            alertError('Échec complet de la réinitialisation. Vérifiez la console.');
        }
        
    } finally {
        // Réactiver le bouton
        resetBtn.disabled = false;
        resetBtn.innerHTML = originalText;
    }
}

// Fonction pour réinitialiser UN MEMBRE spécifique (optionnel - pour debug)
async function resetMemberProgress(memberCode) {
    if (!confirm(`Réinitialiser la progression du membre ${memberCode} ?`)) return;
    
    try {
        const snapshot = await db.collection('hizbReadStatus')
            .where('memberCode', '==', memberCode)
            .where('week', '==', currentWeekKey)
            .get();
        
        if (snapshot.empty) {
            alertInfo('Aucun hizb à réinitialiser pour ce membre');
            return;
        }
        
        const batch = db.batch();
        snapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        alertSuccess(`${snapshot.size} hizb réinitialisés pour ce membre`);
        loadProgress();
        
    } catch (error) {
        console.error('Erreur réinitialisation membre:', error);
        alertError('Erreur lors de la réinitialisation du membre');
    }
}
      
      // ==================== RÉINITIALISATION AUTOMATIQUE TOUS LES VENDREDI 23h59 ====================
// Cette fonction réinitialise les statuts de lecture (lu → non lu) sans supprimer les assignations
async function autoResetHizbReadStatus() {
    try {
        console.log('=== VÉRIFICATION RÉINITIALISATION HEBDOMADAIRE ===');
        
        const now = new Date();
        const dayOfWeek = now.getDay(); // 0 = Dimanche, 1 = Lundi, ..., 5 = Vendredi
        const hours = now.getHours();
        const minutes = now.getMinutes();
        
        // Vérifier si c'est vendredi entre 23h58 et 00h02 (fenêtre de 4 minutes)
        const isFriday = dayOfWeek === 5;
        const isTimeWindow = (hours === 23 && minutes >= 58) || (hours === 0 && minutes <= 2);
        
        if (!isFriday || !isTimeWindow) {
            console.log(`Aujourd'hui: ${dayOfWeek}, Heure: ${hours}h${minutes} - Pas encore l'heure`);
            return;
        }
        
        console.log('🚀 DÉBUT RÉINITIALISATION HEBDOMADAIRE - VENDREDI 23h59');
        
        // Récupérer la semaine actuelle
        const today = new Date();
        const dayOfWeek2 = today.getDay();
        const diffToMonday = dayOfWeek2 === 0 ? -6 : 1 - dayOfWeek2;
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() + diffToMonday);
        const weekKey = `semaine_${startOfWeek.toISOString().split('T')[0]}`;
        
        console.log(`Semaine ciblée: ${weekKey}`);
        
        // Récupérer TOUS les hizb lus de cette semaine
        const readSnapshot = await db.collection('hizbReadStatus')
            .where('week', '==', weekKey)
            .get();
        
        console.log(`${readSnapshot.size} hizb lus à réinitialiser`);
        
        if (readSnapshot.size === 0) {
            console.log('Aucun hizb à réinitialiser');
            return;
        }
        
        // SUPPRIMER tous les statuts de lecture (mais GARDER les assignations)
        const batch = db.batch();
        readSnapshot.docs.forEach(doc => {
            batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        console.log(`✅ ${readSnapshot.size} hizb réinitialisés (lu → non lu) avec SUCCÈS`);
        
        // Envoyer une notification aux membres concernés (optionnel)
        console.log('✅ Réinitialisation hebdomadaire terminée - Tous les hizb sont maintenant "non lus"');
        
    } catch (error) {
        console.error('❌ Erreur réinitialisation automatique:', error);
    }
}

// Fonction pour initialiser le minuteur
function initAutoResetTimer() {
    console.log('🕐 Minuteur de réinitialisation hebdomadaire activé');
    
    // Vérifier toutes les 60 secondes
    setInterval(autoResetHizbReadStatus, 60000); // 60 000 ms = 1 minute
    
    // Exécuter une première fois au chargement
    setTimeout(autoResetHizbReadStatus, 5000); // 5 secondes après le chargement
}
    </script>
  <!-- Modal de confirmation pour suppression -->
<div id="delete-confirmation-modal" class="confirmation-modal">
    <div class="confirmation-box">
        <div class="confirmation-icon">
            <i class="fas fa-trash-alt"></i>
        </div>
        <h3 style="color: white; margin-bottom: 10px;">Confirmer la suppression</h3>
        <p style="color: var(--text-muted); margin-bottom: 20px;">
            Êtes-vous sûr de vouloir supprimer <strong>TOUS</strong> les messages de 
            <span id="member-to-delete-name" style="color: var(--accent-color);"></span> ?
        </p>
        <p style="color: #ff6b6b; font-size: 0.9rem; margin-bottom: 10px;">
            <i class="fas fa-exclamation-triangle"></i> Cette action est irréversible !
        </p>
        <div class="confirmation-buttons">
            <button id="confirm-delete-btn" class="confirm-btn">
                <i class="fas fa-trash"></i> Oui, tout supprimer
            </button>
            <button id="cancel-delete-btn" class="cancel-btn">
                <i class="fas fa-times"></i> Annuler
            </button>
        </div>
    </div>
</div>
  
  <!-- Modal de confirmation pour réinitialisation -->
<div id="reset-confirmation-modal" class="confirmation-modal">
    <div class="confirmation-box">
        <div class="confirmation-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 style="color: white; margin-bottom: 10px;">RÉINITIALISATION TOTALE</h3>
        <p style="color: var(--text-muted); margin-bottom: 20px;">
            Êtes-vous ABSOLUMENT sûr de vouloir réinitialiser <strong>TOUTE</strong> la progression ?
        </p>
        <div style="background: rgba(220, 53, 69, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
            <p style="color: #ff6b6b; margin: 0; font-size: 0.9rem;">
                <i class="fas fa-skull-crossbones"></i> Cette action va :
                <ul style="margin: 10px 0 0 20px; color: white; font-size: 0.85rem;">
                    <li>Supprimer TOUS les hizb marqués comme "lus"</li>
                    <li>Remettre TOUS les hizb assignés en "non lus"</li>
                    <li>Effacer l'historique de lecture de cette semaine</li>
                    <li>Cette action est IRREVERSIBLE !</li>
                </ul>
            </p>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="checkbox" id="confirm-reset-checkbox" style="margin-right: 8px;">
            <label for="confirm-reset-checkbox" style="color: var(--text-muted); font-size: 0.9rem;">
                Je comprends et je confirme cette action
            </label>
        </div>
        <div class="confirmation-buttons">
            <button id="confirm-reset-btn" class="confirm-btn" disabled>
                <i class="fas fa-bomb"></i> OUI, TOUT RÉINITIALISER
            </button>
            <button id="cancel-reset-btn" class="cancel-btn">
                <i class="fas fa-times"></i> ANNULER
            </button>
        </div>
    </div>
</div>
</body>
</html>
